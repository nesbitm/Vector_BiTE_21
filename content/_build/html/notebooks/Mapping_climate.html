
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapping Climate Data to VecDyn &#8212; TheMulQuaBio</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">TheMulQuaBio</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Welcome to The Multilingual Quantitative Biologist!
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Basic Data Analyses and Statistics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats-Intro.html">
   Introduction to this section
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/Mapping_climate.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/mhasoba/TheMulQuaBio"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/mhasoba/TheMulQuaBio/issues/new?title=Issue%20on%20page%20%2Fnotebooks/Mapping_climate.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/mhasoba/TheMulQuaBio/master?urlpath=tree/notebooks/Mapping_climate.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#author-deraj-wilson-aggarwal-imperial-college-london-br-deraj-wilson-aggarwal18-imperial-ac-uk-br-june-2019">
   Author: Deraj Wilson-Aggarwal, Imperial College London
   <br/>
   deraj.wilson-aggarwal18@imperial.ac.uk
   <br/>
   June 2019
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <!--NAVIGATION-->
<p>&lt; | <a class="reference external" href="https://vectorbite.github.io/VBiTraining2/">Main Contents</a> | &gt;</p>
<div class="section" id="mapping-climate-data-to-vecdyn">
<h1>Mapping Climate Data to VecDyn<a class="headerlink" href="#mapping-climate-data-to-vecdyn" title="Permalink to this headline">¶</a></h1>
<div class="section" id="author-deraj-wilson-aggarwal-imperial-college-london-br-deraj-wilson-aggarwal18-imperial-ac-uk-br-june-2019">
<h2>Author: Deraj Wilson-Aggarwal, Imperial College London<br> deraj.wilson-aggarwal18&#64;imperial.ac.uk <br> June 2019<a class="headerlink" href="#author-deraj-wilson-aggarwal-imperial-college-london-br-deraj-wilson-aggarwal18-imperial-ac-uk-br-june-2019" title="Permalink to this headline">¶</a></h2>
<p>There are a plethora of different ways to download climate data. When downloading climate data, it is important to choose a database that has the best coverage possible for your given task as they will differ in their spatial and temporal resolution.</p>
<p>Three main ways to consider are:</p>
<ul>
<li><p><b> Using pre-built Application Program Interfaces (APIs) such as RNOAA and RNCEP </b></p>
<p>APIs such as RNOAA and RNCEP are built packages for software such as R and Python that allows a user to extract climate data with ease. These packages call to servers to download the desired data. This method is great for smaller datasets, being reliable, convenient and efficient.
Although they are convenient, APIs may be difficult to use without steep learning curves. Documentation may not always be widely available. For larger datasets, connecting to servers drastically increases the computational time required to download the relevant data so it is not recommended. <br><br></p>
</li>
<li><p><b> Downloading open source data files and extracting required data from them </b></p>
<p>Downloading and extracting data manually from existing datasets generally requires a large amount of space and can seem clunky. However, when working on large datasets with a medium temporal resolution, they can be extremely efficient. The NetCDF file type is made specifically for climate data and are well suited for their purpose. For more info, please see https://www.unidata.ucar.edu/software/netcdf/docs/netcdf_introduction.html
<br><br>The main drawback of this method, is that it relies on external databases, as before, whilst also providing mid to low level temporal resolution. <br><br></p>
</li>
<li><p><b> Obtaining raster files from satellite data and extracting data using High Performance Computing (HPC) </b></p>
<p>This is a method employed in GIS data analysis. Raster files can be huge, however have the ability to provide high temporal resolution in scales up to 5m. This makes them extremely powerful tools. Generally, the size of these files and the amount of datapoints requried, means that HPC methods are the most efficient ways of extracting the relevant data. <br><br></p>
</li>
</ul>
<p>This notebook will demonstrate how to map climate data to VecDyn data using open source NetCDF NOAA files. The example used is a subset of VecDyn and spans only 2 years, so will be relativlely small in size. I recommend to run any larger datasets using R or RStudio. Feedback on this notebook and its methodology are encouraged, so please do share alternative methods and suggestions with me.</p>
<p>First step, let’s download the data we need.</p>
<p>You may download publicly available NOAA datasets following this link: ftp://ftp.cdc.noaa.gov/Datasets
My suggested datasets, and the ones I have chose to use are are:</p>
<ul class="simple">
<li><p>ftp://ftp.cdc.noaa.gov/Datasets/cpc_global_temp/ for daily maximum temperature data (degrees celsius)</p></li>
<li><p>ftp://ftp.cdc.noaa.gov/Datasets/cpc_global_precip/ for daily Precipitation</p></li>
</ul>
<p>These datasets are available as yearly files, with a spatial resolution of 0.5 degrees latitude and longitude (intervals are at .25 and .75).</p>
<p>Unfortunately, the NOAA file co-ordinates are mapped slightly differently to that of VecDyn, so we need to match these together. The Climate Data Operators (CDO) can allow us to do this, so you will need to download the CDO application (https://code.mpimet.mpg.de/projects/cdo) and run the following code on the command line (from terminal):</p>
<p><code class="docutils literal notranslate"><span class="pre">cdo</span> <span class="pre">-z</span> <span class="pre">zip</span> <span class="pre">sellonlatbox,-180,180,-90,90</span> <span class="pre">INPUT_FILE.nc</span> <span class="pre">OUTPUT_FILE.nc</span> </code></p>
<p>The following code will run through R to download the climate data you will require for this example.</p>
<p><b> Please ensure you have the CDO application downloaded so that you can run it from the command line. <br><br> These files may take 5 minutes to download </b></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># This download will take a couple of minutes as the files are about 60mb each! </span>

<span class="n">Years_to_download</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">2015</span><span class="p">,</span><span class="m">2016</span><span class="p">)</span>

<span class="nf">for </span><span class="p">(</span><span class="n">year</span> <span class="n">in</span> <span class="n">Years_to_download</span><span class="p">){</span>
    
    <span class="c1"># download the files that we require</span>
    <span class="nf">download.file</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;ftp://ftp.cdc.noaa.gov/Datasets/cpc_global_precip/precip.&quot;</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="s">&quot;.nc&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">),</span> <span class="nf">paste</span><span class="p">(</span><span class="s">&quot;../data/precip.&quot;</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="s">&quot;.nc&quot;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">))</span>
    <span class="nf">download.file</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;ftp://ftp.cdc.noaa.gov/Datasets/cpc_global_temp/tmax.&quot;</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="s">&quot;.nc&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">),</span> <span class="nf">paste</span><span class="p">(</span><span class="s">&quot;../data/tmax.&quot;</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="s">&quot;.nc&quot;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">))</span>
    
    <span class="c1"># Use R to go to the terminal and call the cdo remapping </span>
    <span class="nf">system</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;cdo -z zip sellonlatbox,-180,180,-90,90 ../data/precip.&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="s">&quot;.nc ../data/precip.&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="s">&quot;.new.nc&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">))</span>
    <span class="nf">system</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;cdo -z zip sellonlatbox,-180,180,-90,90 ../data/tmax.&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="s">&quot;.nc ../data/tmax.&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="s">&quot;.new.nc&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">))</span>
    
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Next, let’s load in our VecDyn data that we need climate data to map to.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#install.packages(ncdf4)</span>
<span class="c1">#install.packages(chron)</span>
<span class="c1">#install.packages(tidyr)</span>

<span class="nf">library</span><span class="p">(</span><span class="n">ncdf4</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">chron</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span>


<span class="c1"># read in the data file without climate data </span>
<span class="n">Data_no_climate</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&quot;../data/example_import_data.csv&quot;</span><span class="p">)</span>

<span class="n">Data_climate</span> <span class="o">&lt;-</span> <span class="n">Data_no_climate</span>

<span class="c1"># To keep things organised, let&#39;s rename the columns </span>
<span class="nf">names</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">)[</span><span class="m">35</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s">&quot;Initial_latitude&quot;</span>
<span class="nf">names</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">)[</span><span class="m">36</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s">&quot;Initial_longitude&quot;</span>
<span class="nf">names</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">)[</span><span class="m">28</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s">&quot;Collection.date.range&quot;</span>

<span class="c1">##</span>
<span class="c1">## Please note that the indexes above may be a column out </span>
<span class="c1">## due to including row names column when writing the csv </span>
<span class="c1">## </span>
<span class="c1">## If this doesnt work, please try the following code instead and re run:</span>
<span class="c1">#</span>
<span class="c1">#names(Data_climate)[34] &lt;- &quot;Initial_latitude&quot;</span>
<span class="c1">#names(Data_climate)[35] &lt;- &quot;Initial_longitude&quot;</span>
<span class="c1">#names(Data_climate)[27] &lt;- &quot;Collection.date.range&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Now we need to write a couple of functions to incorporate into our loop we use to populate the climate data columns. Some of the co-ordinates used are near to the coast - therefore it is possible that the we have <code class="docutils literal notranslate"><span class="pre">NA</span></code> inputs where the co-ordinate references the sea.</p>
<p>Within the loop, we will include a number of “safety” statements in the form of if/else statements. Therefore, we will be able to catch any <code class="docutils literal notranslate"><span class="pre">NA</span></code>s in our data frame and find the closest values we have.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># A function to round our co-ordinates to the nearest .25 value </span>
<span class="n">rounding</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">value</span><span class="p">){</span>
  <span class="c1"># round to the nearest integer</span>
  <span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="m">0</span><span class="p">)</span>
  <span class="c1"># if rounded up (x&gt;value) reduce by 0.25</span>
  <span class="c1"># else add 0.25 </span>
  <span class="n">new</span> <span class="o">=</span> <span class="nf">ifelse</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">x</span><span class="m">-0.25</span><span class="p">,</span> <span class="n">x</span><span class="m">+0.25</span><span class="p">)</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># A function to round to the other nearest 0.25 </span>
<span class="n">rounding_opposite</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">value</span><span class="p">){</span>
  <span class="c1"># round to the nearest integer</span>
  <span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="m">0</span><span class="p">)</span>
  <span class="c1"># if rounded up (x&gt;value) reduce by 0.25</span>
  <span class="c1"># else add 0.25 </span>
  <span class="n">new</span> <span class="o">=</span> <span class="nf">ifelse</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">x</span><span class="m">+0.25</span><span class="p">,</span> <span class="n">x</span><span class="m">-0.25</span><span class="p">)</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># A function to force rounding up if required </span>
<span class="n">force_round_up</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">value</span><span class="p">){</span>
  <span class="c1"># round UP the nearest integer </span>
  <span class="c1"># minus 0.25 to back towards value </span>
  <span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">ceiling</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="m">0.25</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Now we have defined some functions to round, we can apply them to our current co-ordinate columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Round the latitude and longitude using our previous functions</span>
<span class="c1"># The new co-ordinates are saved as new columns </span>
<span class="n">Data_climate</span><span class="o">$</span><span class="n">latitude</span> <span class="o">&lt;-</span> <span class="nf">rounding</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">Data_climate</span><span class="o">$</span><span class="n">Initial_latitude</span><span class="p">))</span>
<span class="n">Data_climate</span><span class="o">$</span><span class="n">longitude</span> <span class="o">&lt;-</span> <span class="nf">rounding</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">Data_climate</span><span class="o">$</span><span class="n">Initial_longitude</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We also need to ensure that the columns we use are correctly formatted.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert the date </span>
<span class="n">Data_climate</span><span class="o">$</span><span class="n">Collection.date.range</span> <span class="o">&lt;-</span> <span class="nf">as.Date</span><span class="p">(</span><span class="n">Data_climate</span><span class="o">$</span><span class="n">Collection.date.range</span><span class="p">)</span>

<span class="c1"># create a column for the Julian date for later slicing  </span>
<span class="n">Data_climate</span><span class="o">$</span><span class="n">Julian</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">format</span><span class="p">(</span><span class="n">Data_climate</span><span class="o">$</span><span class="n">Collection.date.range</span><span class="p">,</span> <span class="s">&quot;%j&quot;</span><span class="p">))</span>

<span class="c1"># extract year fro mthe date </span>
<span class="n">Data_climate</span><span class="o">$</span><span class="n">Year</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">format</span><span class="p">(</span><span class="n">Data_climate</span><span class="o">$</span><span class="n">Collection.date.range</span><span class="p">,</span> <span class="s">&quot;%Y&quot;</span><span class="p">))</span>

<span class="c1"># order by date and reset indexes </span>
<span class="n">Data_climate</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="nf">order</span><span class="p">(</span><span class="n">Data_climate</span><span class="o">$</span><span class="n">Collection.date.range</span><span class="p">,</span> <span class="n">decreasing</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">),]</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>

<span class="c1"># Create a column of NAs to populate </span>
<span class="n">Data_climate</span><span class="o">$</span><span class="n">Precipitation</span> <span class="o">&lt;-</span> <span class="kc">NA</span>

<span class="c1"># Create a column of NAs to populate </span>
<span class="n">Data_climate</span><span class="o">$</span><span class="n">Max.Temp</span> <span class="o">&lt;-</span> <span class="kc">NA</span>
</pre></div>
</div>
</div>
</div>
<p>Now this is where it might get a little messy and difficult to follow - so bear with me and read through the comments in the loop below one by one. The code is (currently) rather verbose, and is in the process of being optimised. All suggestions are very welcome!</p>
<p>The process, in words, is as follows:</p>
<ul class="simple">
<li><p>For each unique year, find the row indexes that apply to that year</p></li>
<li><p>Open the NetCDF files for that year relating to Precipitation and Maximum Temperature</p></li>
<li><p>Loop through each row index and extract the lat/long</p></li>
<li><p>Extract the precipitation and temperature value for the lat/long</p></li>
<li><p>If there is an <code class="docutils literal notranslate"><span class="pre">NA</span></code> then try again with different lat/long combinations</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">&lt;-</span> <span class="m">0</span>
<span class="n">Year1</span> <span class="o">&lt;-</span> <span class="m">0</span>

<span class="c1"># for each unique year in the dataframe </span>
<span class="nf">for </span><span class="p">(</span><span class="n">Year</span> <span class="n">in</span> <span class="nf">unique</span><span class="p">(</span><span class="n">Data_climate</span><span class="o">$</span><span class="n">Year</span><span class="p">)){</span>
  <span class="nf">print</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Adding climate data for the year &quot;</span><span class="p">,</span> <span class="n">Year</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">))</span>
  <span class="c1"># Draw out the index values in the dataset that correspond to that year </span>
  <span class="n">Year_Index</span> <span class="o">&lt;-</span> <span class="nf">which</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[,</span><span class="s">&quot;Year&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Year</span><span class="p">)</span>
  
  <span class="c1">###############################################</span>
  <span class="c1"># Extract daily precipitation </span>
  <span class="c1">###############################################</span>
  
  <span class="nf">print</span><span class="p">(</span><span class="s">&quot;Opening NetCDF precipitation file&quot;</span><span class="p">)</span>
  <span class="c1"># Define the netCDF file for that year stored in the data directory (please ask for this data as it is very large)</span>
  <span class="n">ncpath_prp</span> <span class="o">&lt;-</span> <span class="s">&quot;../data/&quot;</span>
  <span class="n">ncfname_prp</span> <span class="o">&lt;-</span> <span class="nf">paste</span><span class="p">(</span><span class="n">ncpath_prp</span><span class="p">,</span> <span class="s">&quot;precip.&quot;</span><span class="p">,</span> <span class="n">Year</span><span class="p">,</span> <span class="s">&quot;.new&quot;</span><span class="p">,</span> <span class="s">&quot;.nc&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
  <span class="n">dname_prp</span> <span class="o">&lt;-</span> <span class="s">&quot;precip&quot;</span> 
  
  <span class="c1"># open the netCDF file</span>
  <span class="n">ncin_prp</span> <span class="o">&lt;-</span> <span class="nf">nc_open</span><span class="p">(</span><span class="n">ncfname_prp</span><span class="p">)</span>
  
  <span class="c1"># get longitude and latitude for the factor </span>
  <span class="n">lon_prp</span> <span class="o">&lt;-</span> <span class="nf">ncvar_get</span><span class="p">(</span><span class="n">ncin_prp</span><span class="p">,</span><span class="s">&quot;lon&quot;</span><span class="p">)</span>
  <span class="n">lat_prp</span> <span class="o">&lt;-</span> <span class="nf">ncvar_get</span><span class="p">(</span><span class="n">ncin_prp</span><span class="p">,</span><span class="s">&quot;lat&quot;</span><span class="p">)</span>
  
  <span class="c1"># get the time for that factor </span>
  <span class="n">time</span> <span class="o">&lt;-</span> <span class="nf">ncvar_get</span><span class="p">(</span><span class="n">ncin_prp</span><span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">)</span>
  <span class="n">tunits</span> <span class="o">&lt;-</span> <span class="nf">ncatt_get</span><span class="p">(</span><span class="n">ncin_prp</span><span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">,</span><span class="s">&quot;units&quot;</span><span class="p">)</span>
  <span class="n">nt</span> <span class="o">&lt;-</span> <span class="nf">dim</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
  
  <span class="c1"># Create an array for the precipitation values </span>
  <span class="n">prp_array</span> <span class="o">&lt;-</span> <span class="nf">ncvar_get</span><span class="p">(</span><span class="n">ncin_prp</span><span class="p">,</span><span class="n">dname_prp</span><span class="p">)</span>
  
  <span class="c1"># other factors that may be required/useful</span>
  <span class="n">dlname</span> <span class="o">&lt;-</span> <span class="nf">ncatt_get</span><span class="p">(</span><span class="n">ncin_prp</span><span class="p">,</span><span class="n">dname_prp</span><span class="p">,</span><span class="s">&quot;long_name&quot;</span><span class="p">)</span>
  <span class="n">dunits</span> <span class="o">&lt;-</span> <span class="nf">ncatt_get</span><span class="p">(</span><span class="n">ncin_prp</span><span class="p">,</span><span class="n">dname_prp</span><span class="p">,</span><span class="s">&quot;units&quot;</span><span class="p">)</span>
  <span class="n">fillvalue</span> <span class="o">&lt;-</span> <span class="nf">ncatt_get</span><span class="p">(</span><span class="n">ncin_prp</span><span class="p">,</span><span class="n">dname_prp</span><span class="p">,</span><span class="s">&quot;_FillValue&quot;</span><span class="p">)</span>
  
  <span class="c1"># replace netCDF fill values with NA&#39;s</span>
  <span class="n">prp_array</span><span class="p">[</span><span class="n">prp_array</span><span class="o">==</span><span class="n">fillvalue</span><span class="o">$</span><span class="n">value</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="kc">NA</span>
  
  <span class="c1"># create a matrix for the lon/lats of that file </span>
  <span class="n">lonlat_prp</span> <span class="o">&lt;-</span> <span class="nf">as.matrix</span><span class="p">(</span><span class="nf">expand.grid</span><span class="p">(</span><span class="n">lon_prp</span><span class="p">,</span><span class="n">lat_prp</span><span class="p">))</span>
  
  <span class="c1">###############################################</span>
  <span class="c1"># Extract max daily temperature</span>
  <span class="c1">###############################################</span>
  
  <span class="nf">print</span><span class="p">(</span><span class="s">&quot;Opening NetCDF temperature file&quot;</span><span class="p">)</span>
  <span class="n">ncpath_tmp</span> <span class="o">&lt;-</span> <span class="s">&quot;../data/&quot;</span>
  <span class="n">ncfname_tmp</span> <span class="o">&lt;-</span> <span class="nf">paste</span><span class="p">(</span><span class="n">ncpath_tmp</span><span class="p">,</span> <span class="s">&quot;tmax.&quot;</span><span class="p">,</span> <span class="n">Year</span><span class="p">,</span> <span class="s">&quot;.new&quot;</span><span class="p">,</span> <span class="s">&quot;.nc&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
  <span class="n">dname</span> <span class="o">&lt;-</span> <span class="s">&quot;tmax&quot;</span> 
  
  
  <span class="c1"># open the netCDF file</span>
  <span class="n">ncin_tmp</span> <span class="o">&lt;-</span> <span class="nf">nc_open</span><span class="p">(</span><span class="n">ncfname_tmp</span><span class="p">)</span>
  
  <span class="c1"># get longitude and latitude for factor </span>
  <span class="n">lon_tmp</span> <span class="o">&lt;-</span> <span class="nf">ncvar_get</span><span class="p">(</span><span class="n">ncin_tmp</span><span class="p">,</span><span class="s">&quot;lon&quot;</span><span class="p">)</span>
  <span class="n">lat_tmp</span> <span class="o">&lt;-</span> <span class="nf">ncvar_get</span><span class="p">(</span><span class="n">ncin_tmp</span><span class="p">,</span><span class="s">&quot;lat&quot;</span><span class="p">)</span>
  
  <span class="c1"># extract time</span>
  <span class="n">time</span> <span class="o">&lt;-</span> <span class="nf">ncvar_get</span><span class="p">(</span><span class="n">ncin_tmp</span><span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">)</span>
  <span class="n">tunits</span> <span class="o">&lt;-</span> <span class="nf">ncatt_get</span><span class="p">(</span><span class="n">ncin_tmp</span><span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">,</span><span class="s">&quot;units&quot;</span><span class="p">)</span>
  <span class="n">nt</span> <span class="o">&lt;-</span> <span class="nf">dim</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
  
  <span class="c1"># get temperature </span>
  <span class="n">tmp_array</span> <span class="o">&lt;-</span> <span class="nf">ncvar_get</span><span class="p">(</span><span class="n">ncin_tmp</span><span class="p">,</span><span class="n">dname</span><span class="p">)</span>
  
  <span class="n">dlname</span> <span class="o">&lt;-</span> <span class="nf">ncatt_get</span><span class="p">(</span><span class="n">ncin_tmp</span><span class="p">,</span><span class="n">dname</span><span class="p">,</span><span class="s">&quot;long_name&quot;</span><span class="p">)</span>
  <span class="n">dunits</span> <span class="o">&lt;-</span> <span class="nf">ncatt_get</span><span class="p">(</span><span class="n">ncin_tmp</span><span class="p">,</span><span class="n">dname</span><span class="p">,</span><span class="s">&quot;units&quot;</span><span class="p">)</span>
  <span class="n">fillvalue</span> <span class="o">&lt;-</span> <span class="nf">ncatt_get</span><span class="p">(</span><span class="n">ncin_tmp</span><span class="p">,</span><span class="n">dname</span><span class="p">,</span><span class="s">&quot;_FillValue&quot;</span><span class="p">)</span>
  
  <span class="c1"># replace netCDF fill values with NA&#39;s</span>
  <span class="n">tmp_array</span><span class="p">[</span><span class="n">tmp_array</span><span class="o">==</span><span class="n">fillvalue</span><span class="o">$</span><span class="n">value</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="kc">NA</span>
  
  <span class="c1"># define a matric with temperature lon/lats</span>
  <span class="n">lonlat_tmp</span> <span class="o">&lt;-</span> <span class="nf">as.matrix</span><span class="p">(</span><span class="nf">expand.grid</span><span class="p">(</span><span class="n">lon_tmp</span><span class="p">,</span><span class="n">lat_tmp</span><span class="p">))</span>
  <span class="nf">print</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Running for the year &quot;</span><span class="p">,</span> <span class="n">Year</span><span class="p">,</span><span class="s">&quot;. There are &quot;</span><span class="p">,</span> <span class="nf">length</span><span class="p">(</span><span class="n">Year_Index</span><span class="p">),</span> <span class="s">&quot; rows, from &quot;</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="n">Year_Index</span><span class="p">),</span> <span class="s">&quot;to&quot;</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="n">Year_Index</span><span class="p">)))</span>
  
  <span class="c1"># loop to extract climate data and save</span>
  <span class="nf">for </span><span class="p">(</span><span class="n">row</span> <span class="n">in</span> <span class="n">Year_Index</span><span class="p">){</span>
    <span class="c1"># define the Julian day for that row </span>
    <span class="n">j</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Julian&quot;</span><span class="p">]</span>
    <span class="c1"># define the lon/lats of the row </span>
    <span class="n">lon_n</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;longitude&quot;</span><span class="p">]</span>
    <span class="n">lat_n</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;latitude&quot;</span><span class="p">]</span>
    
    <span class="c1"># If the julian day differs, or the year differs from the previous row</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">j</span><span class="o">!=</span><span class="n">i</span> <span class="o">|</span> <span class="n">Year</span> <span class="o">!=</span> <span class="n">Year1</span><span class="p">){</span>
      <span class="c1"># redefine i as j </span>
      <span class="n">i</span> <span class="o">&lt;-</span> <span class="n">j</span>
      <span class="c1"># Slice the temp data into the day required</span>
      <span class="n">tmp_slice</span> <span class="o">&lt;-</span> <span class="n">tmp_array</span><span class="p">[,,</span><span class="n">i</span><span class="p">]</span>
      <span class="c1"># store as a vector</span>
      <span class="n">tmp_vec</span> <span class="o">&lt;-</span> <span class="nf">as.vector</span><span class="p">(</span><span class="n">tmp_slice</span><span class="p">)</span>
      <span class="c1"># bind as a dataframe with the lon/lats of the factor </span>
      <span class="n">tmp_df01</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="nf">cbind</span><span class="p">(</span><span class="n">lonlat_tmp</span><span class="p">,</span><span class="n">tmp_vec</span><span class="p">))</span>
      <span class="c1"># add the temp value for the rows long/lats on tht day  </span>
      <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Max.Temp&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">tmp_df01</span><span class="p">,</span> <span class="n">tmp_vec</span><span class="p">[</span><span class="n">Var2</span> <span class="o">==</span> <span class="n">lat_n</span> <span class="o">&amp;</span> <span class="n">Var1</span> <span class="o">==</span> <span class="n">lon_n</span><span class="p">])</span>
      
      <span class="c1"># Same again but for precipitation </span>
      <span class="n">prp_slice</span> <span class="o">&lt;-</span> <span class="n">prp_array</span><span class="p">[,,</span><span class="n">i</span><span class="p">]</span>
      <span class="n">prp_vec</span> <span class="o">&lt;-</span> <span class="nf">as.vector</span><span class="p">(</span><span class="n">prp_slice</span><span class="p">)</span>
      <span class="n">prp_df01</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="nf">cbind</span><span class="p">(</span><span class="n">lonlat_prp</span><span class="p">,</span><span class="n">prp_vec</span><span class="p">))</span>
      <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Precipitation&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">prp_df01</span><span class="p">,</span> <span class="n">prp_vec</span><span class="p">[</span><span class="n">Var2</span> <span class="o">==</span> <span class="n">lat_n</span> <span class="o">&amp;</span> <span class="n">Var1</span> <span class="o">==</span> <span class="n">lon_n</span><span class="p">])</span>
      
    <span class="p">}</span>
    <span class="c1"># otherwise, if Julian day does not differ NOR does the year </span>
    <span class="n">else</span><span class="p">{</span>
      <span class="c1"># Go straight in and extract from the existing slice for that lon/lat</span>
      <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Max.Temp&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">tmp_df01</span><span class="p">,</span> <span class="n">tmp_vec</span><span class="p">[</span><span class="n">Var2</span> <span class="o">==</span> <span class="n">lat_n</span> <span class="o">&amp;</span> <span class="n">Var1</span> <span class="o">==</span> <span class="n">lon_n</span><span class="p">])</span>
      <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Precipitation&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">prp_df01</span><span class="p">,</span> <span class="n">prp_vec</span><span class="p">[</span><span class="n">Var2</span> <span class="o">==</span> <span class="n">lat_n</span> <span class="o">&amp;</span> <span class="n">Var1</span> <span class="o">==</span> <span class="n">lon_n</span><span class="p">])</span>
      
    <span class="p">}</span>
    <span class="c1"># redefine the previous year once the years index has been completed</span>
    
    <span class="nf">if </span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Max.Temp&quot;</span><span class="p">])){</span>
      <span class="c1"># Try a different latitude</span>
      <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">rounding</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Initial_latitude&quot;</span><span class="p">])</span>
      <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">rounding_opposite</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Initial_longitude&quot;</span><span class="p">])</span>
      
      <span class="c1"># define the lon/lats of the row</span>
      <span class="n">lon_n</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;longitude&quot;</span><span class="p">]</span>
      <span class="n">lat_n</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;latitude&quot;</span><span class="p">]</span>
      <span class="c1">#print(paste(&quot;Attempting again for row &quot;, row, &quot;at lon/lat &quot;, lon_n, &quot;,&quot;,lat_n))</span>
      
      
      <span class="c1"># add the temp value for the rows long/lats on tht day</span>
      <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Max.Temp&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">tmp_df01</span><span class="p">,</span> <span class="n">tmp_vec</span><span class="p">[</span><span class="n">Var2</span> <span class="o">==</span> <span class="n">lat_n</span> <span class="o">&amp;</span> <span class="n">Var1</span> <span class="o">==</span> <span class="n">lon_n</span><span class="p">])</span>
      
      
      <span class="nf">if </span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s">&quot;Max.Temp&quot;</span><span class="p">])){</span>
        <span class="c1"># try a different longitude</span>
        <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">rounding_opposite</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Initial_latitude&quot;</span><span class="p">])</span>
        <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">rounding</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Initial_longitude&quot;</span><span class="p">])</span>
        
        <span class="c1"># define the lon/lats of the row</span>
        <span class="n">lon_n</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;longitude&quot;</span><span class="p">]</span>
        <span class="n">lat_n</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;latitude&quot;</span><span class="p">]</span>
        <span class="c1">#print(paste(&quot;Attempting second time for row &quot;, row, &quot;at lon/lat &quot;, lon_n, &quot;,&quot;, lat_n))</span>
        
        <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Max.Temp&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">tmp_df01</span><span class="p">,</span> <span class="n">tmp_vec</span><span class="p">[</span><span class="n">Var2</span> <span class="o">==</span> <span class="n">lat_n</span> <span class="o">&amp;</span> <span class="n">Var1</span> <span class="o">==</span> <span class="n">lon_n</span><span class="p">])</span>
        
        <span class="nf">if </span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s">&quot;Max.Temp&quot;</span><span class="p">])){</span>
          <span class="c1"># try a different longitude</span>
          <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">rounding_opposite</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Initial_latitude&quot;</span><span class="p">])</span>
          <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">rounding_opposite</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Initial_longitude&quot;</span><span class="p">])</span>
          
          <span class="c1"># define the lon/lats of the row</span>
          <span class="n">lon_n</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;longitude&quot;</span><span class="p">]</span>
          <span class="n">lat_n</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;latitude&quot;</span><span class="p">]</span>
          <span class="nf">print</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Attempting third time for row &quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="s">&quot;at lon/lat &quot;</span><span class="p">,</span><span class="n">lon_n</span><span class="p">,</span><span class="s">&quot;,&quot;</span><span class="p">,</span><span class="n">lat_n</span><span class="p">))</span>
          
          <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Max.Temp&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">tmp_df01</span><span class="p">,</span> <span class="n">tmp_vec</span><span class="p">[</span><span class="n">Var2</span> <span class="o">==</span> <span class="n">lat_n</span> <span class="o">&amp;</span> <span class="n">Var1</span> <span class="o">==</span> <span class="n">lon_n</span><span class="p">])</span>
          
          <span class="nf">if </span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s">&quot;Max.Temp&quot;</span><span class="p">])){</span>
            <span class="c1"># Try a different latitude</span>
            <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">rounding</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Initial_latitude&quot;</span><span class="p">])</span>
            <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">force_round_up</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Initial_longitude&quot;</span><span class="p">])</span>
            
            <span class="c1"># define the lon/lats of the row</span>
            <span class="n">lon_n</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;longitude&quot;</span><span class="p">]</span>
            <span class="n">lat_n</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;latitude&quot;</span><span class="p">]</span>
            <span class="c1">#print(paste(&quot;Attempting again for row &quot;, row, &quot;at lon/lat &quot;, lon_n, &quot;,&quot;,lat_n))</span>
            
            
            <span class="c1"># add the temp value for the rows long/lats on tht day</span>
            <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Max.Temp&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">tmp_df01</span><span class="p">,</span> <span class="n">tmp_vec</span><span class="p">[</span><span class="n">Var2</span> <span class="o">==</span> <span class="n">lat_n</span> <span class="o">&amp;</span> <span class="n">Var1</span> <span class="o">==</span> <span class="n">lon_n</span><span class="p">])</span>
            
            <span class="nf">if </span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Max.Temp&quot;</span><span class="p">])){</span>
              
              <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">force_round_up</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Initial_latitude&quot;</span><span class="p">])</span>
              <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">rounding</span><span class="p">(</span><span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Initial_longitude&quot;</span><span class="p">])</span>
              
              <span class="c1"># define the lon/lats of the row</span>
              <span class="n">lon_n</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;longitude&quot;</span><span class="p">]</span>
              <span class="n">lat_n</span> <span class="o">&lt;-</span> <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;latitude&quot;</span><span class="p">]</span>
              <span class="c1">#print(paste(&quot;Attempting second time for row &quot;, row, &quot;at lon/lat &quot;, lon_n, &quot;,&quot;,lat_n))</span>
              
              
              <span class="c1"># add the temp value for the rows long/lats on tht day</span>
              <span class="n">Data_climate</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;Max.Temp&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">tmp_df01</span><span class="p">,</span> <span class="n">tmp_vec</span><span class="p">[</span><span class="n">Var2</span> <span class="o">==</span> <span class="n">lat_n</span> <span class="o">&amp;</span> <span class="n">Var1</span> <span class="o">==</span> <span class="n">lon_n</span><span class="p">])</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">Year1</span> <span class="o">==</span> <span class="n">Year</span>
  <span class="p">}</span> 
  
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>It’s important to check the values that we’ve obtained are as we expect using <code class="docutils literal notranslate"><span class="pre">summary()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">summary</span><span class="p">(</span><span class="n">Data_climate</span><span class="o">$</span><span class="n">Precipitation</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">Data_climate</span><span class="o">$</span><span class="n">Max.Temp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, let’s save our output to a new <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file, ready to import and analyse:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># write.csv(Data_climate, &quot;../data/example_import_data_with_climate.csv&quot;, row.names=FALSE)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            kernelName: "ir",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Samraat Pawar<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>