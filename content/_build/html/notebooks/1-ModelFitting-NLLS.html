
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Model Fitting using Non-linear Least-squares &#8212; TheMulQuaBio</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">TheMulQuaBio</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Welcome to The Multilingual Quantitative Biologist!
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Basic Data Analyses and Statistics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats-Intro.html">
   Introduction to this section
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/1-ModelFitting-NLLS.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/mhasoba/TheMulQuaBio"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/mhasoba/TheMulQuaBio/issues/new?title=Issue%20on%20page%20%2Fnotebooks/1-ModelFitting-NLLS.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/mhasoba/TheMulQuaBio/master?urlpath=tree/notebooks/1-ModelFitting-NLLS.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#traits-data-as-an-example">
   Traits data as an example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#biochemical-kinetics">
   Biochemical Kinetics
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generating-data">
     Generating data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fitting-the-model">
     Fitting the model
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#confidence-intervals">
   Confidence Intervals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-squared-values">
   R-squared values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-starting-values-problem">
   The starting values problem
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-more-robust-nlls-algorithm">
   A more robust NLLS algorithm
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bounding-parameter-values">
   Bounding parameter values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#diagnostics-of-an-nlls-fit">
   Diagnostics of an NLLS fit
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#allometric-scaling-of-traits">
   Allometric scaling of traits
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#nlls-fitting-using-model-objects">
   NLLS fitting using model objects
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercises-a-id-allom-exercises-a">
     Exercises
     <a id="Allom_Exercises">
     </a>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparing-models">
   Comparing models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercises-a-id-modelselection-exercises-a">
     Exercises
     <a id="ModelSelection_Exercises">
     </a>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#albatross-chick-growth">
   Albatross chick growth
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fitting-the-three-models-using-nlls">
     Fitting the three models using NLLS
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercises-a-id-albatross-exercises-a">
     Exercises
     <a id="Albatross_Exercises">
     </a>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aedes-aegypti-fecundity">
   Aedes aegypti fecundity
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-thermal-performance-curve-models">
     The Thermal Performance Curve models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercises-a-id-aedes-exercises-a">
     Exercises
     <a id="Aedes_Exercises">
     </a>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#abundance-data-as-an-example">
   Abundance data as an example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#population-growth-rates">
   Population growth rates
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#basic-approach">
     Basic approach
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-ols">
     Using OLS
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-nlls">
     Using NLLS
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercises">
     Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#some-tips-and-tricks-for-nlls-fitting">
   Some tips and tricks for NLLS fitting
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#starting-values">
     Starting values
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#obtaining-them">
       Obtaining them
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sampling-them">
       Sampling them
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#bounding-parameters-revisited">
     Bounding parameters revisited
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#readings-and-resources">
   Readings and Resources
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="model-fitting-using-non-linear-least-squares">
<h1>Model Fitting using Non-linear Least-squares<a class="headerlink" href="#model-fitting-using-non-linear-least-squares" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In this Chapter, you will learn to fit non-linear mathematical models to data using Non-Linear Least Squares (NLLS).</p>
<p>Specifically, you will learn to</p>
<ul class="simple">
<li><p>Visualize the data and the mathematical model you want to fit to them</p></li>
<li><p>Fit a non-linear model</p></li>
<li><p>Assess the quality of the fit, and whether the model is appropriate for your data</p></li>
<li><p>Compare and select between competing models</p></li>
</ul>
<p>We will work through various examples. These assume that you have at least a conceptual understanding of what Linear vs Non-linear models are, how they are fitted to data, and how the fits can be assessed statistically. You may want to see the <a class="reference external" href="https://github.com/mhasoba/TheMulQuaBio/tree/master/content/lectures/LinearModels">Linear Models lecture</a> (you can also watch the <a class="reference external" href="https://drive.google.com/drive/folders/12Sj56wHX6vcAnp9GE9qQ1gIXbn7QRHU2?usp=sharing">video</a>), and the <a class="reference external" href="https://github.com/mhasoba/TheMulQuaBio/blob/master/content/lectures/NLLS">NLLS Lecture</a> lecture first (you can also watch the <span class="xref myst">video</span>).</p>
<p>You may also (optionally) want to see the  <a class="reference external" href="https://github.com/mhasoba/TheMulQuaBio/tree/master/content/lectures/ModelFitting">lecture on model fitting in Ecology and Evolution in general</a>).</p>
<p>We will use R. For starters, clear all variables and graphic devices and load necessary packages:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">rm</span><span class="p">(</span><span class="n">list</span> <span class="o">=</span> <span class="nf">ls</span><span class="p">())</span>
<span class="nf">graphics.off</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="traits-data-as-an-example">
<h2>Traits data as an example<a class="headerlink" href="#traits-data-as-an-example" title="Permalink to this headline">¶</a></h2>
<p>Our first set of examples will focus on traits.</p>
<p>A trait is any measurable feature of an individual organism. This includes physical traits (e.g., morphology, body mass, wing length), performance traits (e.g., biochemical kinetics, respiration rate, body velocity, fecundity), and behavioral traits (e.g., feeding preference, foraging strategy, mate choice). All natural populations show variation in traits across individuals. A trait is functional when it directly (e.g., mortality rate) or indirectly (e.g., somatic development or growth rate) determines individual fitness. Therefore, variation in (functional) traits can generate variation in the rate of increase and persistence of populations. When measured in the context of life cycles, without considering interactions with other organisms (e.g., predators or prey of the focal population), functional traits are typically called life history traits (such as mortality rate and fecundity). Other traits determine interactions both within the focal population (e.g., intra-specific interference or mating frequency) and between the focal population/species and others, including the species which may act as resources (prey, for example). Thus both life history and interaction traits determine population fitness and therefore abundance, which ultimately influences dynamics and functioning of the wider ecosystem, such as carbon fixation rate or disease transmission rate.</p>
</div>
<div class="section" id="biochemical-kinetics">
<h2>Biochemical Kinetics<a class="headerlink" href="#biochemical-kinetics" title="Permalink to this headline">¶</a></h2>
<p>The properties of an organism’s metabolic pathways, and the underlying (enzyme-mediated) biochemical reactions (kinetics) are arguably its most fundamental “traits”, because these drive all “performance” traits, from photosynthesis and respiration, to movement and growth rate.</p>
<p>The <a class="reference external" href="https://en.wikipedia.org/wiki/Michaelis%E2%80%93Menten_kinetics">Michaelis-Menten</a> model is widely used to quantify reaction kinetics data and estimate key biochemical parameters. This model relates biochemical reaction rate (<span class="math notranslate nohighlight">\(V\)</span>) (rate of formation of the product of the reaction), to concentration of the substrate (<span class="math notranslate nohighlight">\(S\)</span>):</p>
<div class="math notranslate nohighlight" id="equation-eq-m-m">
<span class="eqno">()<a class="headerlink" href="#equation-eq-m-m" title="Permalink to this equation">¶</a></span>\[ 
V = \frac{V_{\max} S}{K_M + S} 
\]</div>
<p>Here,</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(V_{\max}\)</span> is the maximum rate that can be achieved in the reaction system, which happens at saturating substrate concentration, and</p></li>
<li><p><span class="math notranslate nohighlight">\(K_M\)</span> is the Michaelis or half-saturation constant, defined as the substrate concentration at which the reaction rate is half of <span class="math notranslate nohighlight">\(V_{\max }\)</span>.</p></li>
</ul>
<p>Biochemical reactions involving a single substrate are often well fitted by the Michaelis-Menten kinetics, suggesting that its assumptions are often valid.</p>
<img src="./graphics/MM.png" alt="Michaelis-Menten model" width="400px">
<p><small><center>The Michaelis-Menten model.</center></small></p>
<p>Let’s fit the Michaelis-Menten model to some data.</p>
<div class="section" id="generating-data">
<h3>Generating data<a class="headerlink" href="#generating-data" title="Permalink to this headline">¶</a></h3>
<p>Instead of using real experimental data, we will actually <em>generate</em> some “data” because that way we know exactly what the errors in the data are. You can also import and use your own dataset for the fitting steps further below.</p>
<p>We can generate some data as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">S_data</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">50</span><span class="p">,</span><span class="m">1</span><span class="p">)</span> <span class="c1"># Generate a sequence of substrate concentrations</span>
<span class="n">S_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li><li>21</li><li>22</li><li>23</li><li>24</li><li>25</li><li>26</li><li>27</li><li>28</li><li>29</li><li>30</li><li>31</li><li>32</li><li>33</li><li>34</li><li>35</li><li>36</li><li>37</li><li>38</li><li>39</li><li>40</li><li>41</li><li>42</li><li>43</li><li>44</li><li>45</li><li>46</li><li>47</li><li>48</li><li>49</li><li>50</li></ol>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">V_data</span> <span class="o">&lt;-</span> <span class="p">((</span><span class="m">12.5</span> <span class="o">*</span> <span class="n">S_data</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="m">7.1</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">))</span> <span class="c1"># Generate a Michaelis-Menten response with V_max = 12.5 and K_M = 7.1</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">S_data</span><span class="p">,</span> <span class="n">V_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_8_0.png" src="../_images/1-ModelFitting-NLLS_8_0.png" />
</div>
</div>
<p>Note that our choice of <span class="math notranslate nohighlight">\(V_{\max} = 12.5\)</span> and <span class="math notranslate nohighlight">\(K_M = 7.1\)</span> is completely arbitrary. As long as we make sure that <span class="math notranslate nohighlight">\(V_{\max} &gt; 0\)</span>, <span class="math notranslate nohighlight">\(K_H &gt; 0\)</span>, and <span class="math notranslate nohighlight">\(K_M\)</span> lies well within the lower half of the the range of substrate concentrations (0-50), these “data” will be physically biologically sensible.</p>
<p>Now let’s add some random (normally-distributed) fluctuations to the data to emulate experimental / measurement error:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set.seed</span><span class="p">(</span><span class="m">1456</span><span class="p">)</span> <span class="c1"># To get the same random fluctuations in the &quot;data&quot; every time</span>
<span class="n">V_data</span> <span class="o">&lt;-</span> <span class="n">V_data</span> <span class="o">+</span> <span class="nf">rnorm</span><span class="p">(</span><span class="m">50</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">)</span> <span class="c1"># Add random fluctuations to emulate error with standard deviation of 0.5</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">S_data</span><span class="p">,</span> <span class="n">V_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_10_0.png" src="../_images/1-ModelFitting-NLLS_10_0.png" />
</div>
</div>
<p>That looks real!</p>
</div>
<div class="section" id="fitting-the-model">
<h3>Fitting the model<a class="headerlink" href="#fitting-the-model" title="Permalink to this headline">¶</a></h3>
<p>Now, fit the model to the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">MM_model</span> <span class="o">&lt;-</span> <span class="nf">nls</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in nls(V_data ~ V_max * S_data/(K_M + S_data)):
“No starting values specified for some parameters.
Initializing ‘V_max’, ‘K_M’ to &#39;1.&#39;.
Consider specifying &#39;start&#39; or using a selfStart model”
</pre></div>
</div>
</div>
</div>
<p>This warning arises because <code class="docutils literal notranslate"><span class="pre">nls</span></code> requires “starting values” for the parameters (two in this case: <code class="docutils literal notranslate"><span class="pre">V_max</span></code> and <code class="docutils literal notranslate"><span class="pre">K_M</span></code>) to start searching for optimal combinations of parameter values (ones that minimize the RSS). Indeed, all NLLS fitting functions / algorithms require this. If you do not provide starting values, <code class="docutils literal notranslate"><span class="pre">nls</span></code> gives you a warning (as above) and uses a starting value of 1 for every parameter by default. For simple models, despite the warning, this works well enough.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Before proceeding further, have a look at what <code class="docutils literal notranslate"><span class="pre">nls()</span></code>’s arguments are using <code class="docutils literal notranslate"><span class="pre">?nls</span></code>, or looking at the documentation <a class="reference external" href="https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/nls">online</a>.</p>
</div>
<p>We will address the issue of starting values soon enough, but first let’s look at how good the fit that we obtained looks. The first thing to do is to see how well the model fitted the data, for which plotting is the best  first option:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">S_data</span><span class="p">,</span><span class="n">V_data</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="s">&quot;Substrate Concentration&quot;</span><span class="p">,</span> <span class="n">ylab</span> <span class="o">=</span> <span class="s">&quot;Reaction Rate&quot;</span><span class="p">)</span>  <span class="c1"># first plot the data </span>
<span class="nf">lines</span><span class="p">(</span><span class="n">S_data</span><span class="p">,</span><span class="nf">predict</span><span class="p">(</span><span class="n">MM_model</span><span class="p">),</span><span class="n">lty</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s">&quot;blue&quot;</span><span class="p">,</span><span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span> <span class="c1"># now overlay the fitted model </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_15_0.png" src="../_images/1-ModelFitting-NLLS_15_0.png" />
</div>
</div>
<p>This looks pretty good.</p>
<p>Note that we used we used the <code class="docutils literal notranslate"><span class="pre">predict()</span></code> function here just as we did in any of the linear models chapters (e.g., <a class="reference external" href="16-MulExp:Predicted-values">here</a>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In general, you can use most of the same commands/functions (e.g., <code class="docutils literal notranslate"><span class="pre">predict()</span></code> and <code class="docutils literal notranslate"><span class="pre">summary()</span></code>) on the output of a <code class="docutils literal notranslate"><span class="pre">nls()</span></code> model fitting object as you would on a <code class="docutils literal notranslate"><span class="pre">lm()</span></code> model fitting object.</p>
</div>
<p>Now lets get some stats of this NLLS fit. Having obtained the fit object (<code class="docutils literal notranslate"><span class="pre">MM_model</span></code>), we can use <code class="docutils literal notranslate"><span class="pre">summary()</span></code> just like we would for a <code class="docutils literal notranslate"><span class="pre">lm()</span></code> fit object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">summary</span><span class="p">(</span><span class="n">MM_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Formula: V_data ~ V_max * S_data/(K_M + S_data)

Parameters:
      Estimate Std. Error t value Pr(&gt;|t|)    
V_max  13.5041     0.5345  25.265  &lt; 2e-16 ***
K_M     9.4085     1.3198   7.128 4.67e-09 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1.001 on 48 degrees of freedom

Number of iterations to convergence: 7 
Achieved convergence tolerance: 1.938e-06
</pre></div>
</div>
</div>
</div>
<p>This looks a lot like the output of a linear model, and to be specific, of a <span class="xref myst">Linear Regression</span>. For starters, compare the above output with the output of <code class="docutils literal notranslate"><span class="pre">summary(genomeSizeModelDragon)</span></code> in <a class="reference external" href="regress:perform">this section</a> of the Linear Regression chapter.</p>
<p>So here are the main things to note about the output of <code class="docutils literal notranslate"><span class="pre">summary()</span></code> of an <code class="docutils literal notranslate"><span class="pre">nls()</span></code> model object:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Estimate</span></code>s are, as in the output of the <code class="docutils literal notranslate"><span class="pre">lm()</span></code> function for fitting linear models, the estimated values of the coefficients of the model that you fitted (<span class="math notranslate nohighlight">\(V_(\max)\)</span> and <span class="math notranslate nohighlight">\(K_M\)</span>). Note that although we generated our data using <span class="math notranslate nohighlight">\(V_{\max} = 12.5\)</span> and <span class="math notranslate nohighlight">\(K_M = 7.1\)</span>, the actual coefficients are quite different from what we are getting with the NLLS fitting (<span class="math notranslate nohighlight">\(\hat{V_{\max} = 13.5\)</span> and <span class="math notranslate nohighlight">\(\hat{K}_M = 9.4\)</span>). This is because we introduced random (normally-distributed) errors. This tell you something about how experimental and/or measurement errors can distort your image of the underlying mechanism or process.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Std.</span> <span class="pre">Error</span></code>, <code class="docutils literal notranslate"><span class="pre">t</span> <span class="pre">value</span></code>, and <code class="docutils literal notranslate"><span class="pre">Pr(&gt;|t|)</span></code> and <code class="docutils literal notranslate"><span class="pre">Residual</span> <span class="pre">standard</span> <span class="pre">error</span></code> have the same interpretation as in the output of <code class="docutils literal notranslate"><span class="pre">lm()</span></code> (please look back at the <span class="xref myst">Linear Regression Chapter</span>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Number</span> <span class="pre">of</span> <span class="pre">iterations</span> <span class="pre">to</span> <span class="pre">convergence</span></code> tells you how many times the NLLS algorithm had to adjust the parameter values till it managed to find a solution that minimizes the Residual Sum of Squares (RSS)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Achieved</span> <span class="pre">convergence</span> <span class="pre">tolerance</span></code> tells you on what basis the algorithm decided that it was close enough to the a solution; basically if the RSS does not improve more than a certain threshold despite parameter adjustments, the algorithm stops searching. This may or may not be close to an optimal solution (but in this case it is).</p></li>
</ul>
<p>The last two items are specific to the output of an <code class="docutils literal notranslate"><span class="pre">nls()</span></code> fitting <code class="docutils literal notranslate"><span class="pre">summary()</span></code>, because unlike Ordinary Least Squares (OLS), which is what we used for Linear regression, NLLS is not an <em>exact</em> procedure, and the fitting requires computer simulations; revisit the <a class="reference external" href="https://github.com/mhasoba/TheMulQuaBio/blob/master/lectures/NLLS">Lecture</a> for an explanation of this. This is all you need to know for now. As such, you do not need to report these last two items when presenting the results of an NLLS fit, but they are useful for problem solving in case the fitting does not work (more on this below).</p>
<p>As noted above, you can use the same sort of commands on a <code class="docutils literal notranslate"><span class="pre">nls()</span></code> fitting result as you can on a <code class="docutils literal notranslate"><span class="pre">lm()</span></code> object.</p>
<p>For example, you can get just the values of the estimated coefficients using:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">coef</span><span class="p">(</span><span class="n">MM_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041180721635</dd><dt>K_M</dt><dd>9.40846157841925</dd></dl>
</div></div>
</div>
<p>Thus, much of the output of NLLS fitting using <code class="docutils literal notranslate"><span class="pre">nls()</span></code> is analogous to the output of an <code class="docutils literal notranslate"><span class="pre">lm()</span></code>. However, further statistical inference here cannot be done using Analysis of Variance (ANOVA), because the model is not a Linear Model. Try <code class="docutils literal notranslate"><span class="pre">anova(MM_model)</span></code>, and see what happens. We will address statistical inference with NLLS model fitting further below (with a different example).</p>
</div>
</div>
<div class="section" id="confidence-intervals">
<h2>Confidence Intervals<a class="headerlink" href="#confidence-intervals" title="Permalink to this headline">¶</a></h2>
<p>One particularly useful thing you can do after NLLS fitting is to calculate/construct the confidence intervals (CI’s) around the estimated parameters in our fitted model, analogous to how we would in the OLS fitting used for Linear Models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">confint</span><span class="p">(</span><span class="n">MM_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Waiting for profiling to be done...
</pre></div>
</div>
<div class="output text_html"><table>
<caption>A matrix: 2 × 2 of type dbl</caption>
<thead>
	<tr><th></th><th scope=col>2.5%</th><th scope=col>97.5%</th></tr>
</thead>
<tbody>
	<tr><th scope=row>V_max</th><td>12.538677</td><td>14.66093</td></tr>
	<tr><th scope=row>K_M</th><td> 7.124685</td><td>12.36158</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Waiting</span> <span class="pre">for</span> <span class="pre">profiling</span> <span class="pre">to</span> <span class="pre">be</span> <span class="pre">done...</span></code> message reflects the fact that calculating the standard errors from which the CI’s are calculated requires a particular computational procedure (which we will not go into here) when it comes to NLLS fits. Calculating confidence intervals can be useful because, as you learned <span class="xref myst">here</span>, <span class="xref myst">here</span>, and <a class="reference external" href="15-anova:CI">here</a> (among other places) you can use a coefficient/parameter estimate’s confidence intervals to test whether it is significantly different from some reference value. Note that the intervals for <code class="docutils literal notranslate"><span class="pre">K_M</span></code> do not include the original value of <span class="math notranslate nohighlight">\(K_M = 7.1\)</span> that we used to generate the data!.</p>
<p>Also, the intervals should not include zero for the coefficient to be statistically significant in itself, that is, different from zero.</p>
</div>
<div class="section" id="r-squared-values">
<h2>R-squared values<a class="headerlink" href="#r-squared-values" title="Permalink to this headline">¶</a></h2>
<p>To put it simply, unlike an R<span class="math notranslate nohighlight">\(^2\)</span> value obtained by fitting a linear model, that obtained from NLLS fitting is not reliable, and should not be used. The reason for this is somewhat technical (e.g., see this <a class="reference external" href="https://dx.doi.org/10.1186%2F1471-2210-10-6">paper</a>) and we won’t go into it here. But basically, NLLS R<span class="math notranslate nohighlight">\(^2\)</span> values do not always accurately reflect the quality of fit, and definitely cannot be used to select between competing models (Model selection, as you learned <span class="xref myst">previously</span>). Indeed R<span class="math notranslate nohighlight">\(^2\)</span> values obtained from NLLS fitting even be negative when the model fits very poorly! We will learn more about model selection with non-linear models later below.</p>
</div>
<div class="section" id="the-starting-values-problem">
<h2>The starting values problem<a class="headerlink" href="#the-starting-values-problem" title="Permalink to this headline">¶</a></h2>
<p>Now let’s revisit the issue of starting values in NLLS fitting. Previously, we fitted the Michaelis-Menten Model without any starting values, and R gave us a warning but managed to fit the model to our synthetic “data” using default starting values.</p>
<p>Lets try the NLLS fitting again, but with some particular starting values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">MM_model2</span> <span class="o">&lt;-</span> <span class="nf">nls</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Note that unlike before, we got no warning message about starting values.</p>
<p>Let’s compare the coefficient estimates from our two different model fits to the same dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">coef</span><span class="p">(</span><span class="n">MM_model</span><span class="p">)</span>
<span class="nf">coef</span><span class="p">(</span><span class="n">MM_model2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041180721635</dd><dt>K_M</dt><dd>9.40846157841925</dd></dl>
</div><div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041046181521</dd><dt>K_M</dt><dd>9.40842557733051</dd></dl>
</div></div>
</div>
<p>Not too different, but not exactly the same!</p>
<p>In contrast, when you fit linear models you will get exactly the same coefficient estimates every single time, because OLS is an <em>exact</em> procedure.</p>
<p>Now, let’s try even more different start values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">MM_model3</span> <span class="o">&lt;-</span> <span class="nf">nls</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="n">.</span><span class="m">01</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Compare the coefficients of this model fit to the two previous ones:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">coef</span><span class="p">(</span><span class="n">MM_model</span><span class="p">)</span>
<span class="nf">coef</span><span class="p">(</span><span class="n">MM_model2</span><span class="p">)</span>
<span class="nf">coef</span><span class="p">(</span><span class="n">MM_model3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041180721635</dd><dt>K_M</dt><dd>9.40846157841925</dd></dl>
</div><div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041046181521</dd><dt>K_M</dt><dd>9.40842557733051</dd></dl>
</div><div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>2.95615964317118</dd><dt>K_M</dt><dd>-3.47473176418547</dd></dl>
</div></div>
</div>
<p>The estimates in our latest model fit are completely different (in fact, <code class="docutils literal notranslate"><span class="pre">K_M</span></code> is negative)! Let’s plot this model’s and the first model’s fit together:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">S_data</span><span class="p">,</span><span class="n">V_data</span><span class="p">)</span>  <span class="c1"># first plot the data </span>
<span class="nf">lines</span><span class="p">(</span><span class="n">S_data</span><span class="p">,</span><span class="nf">predict</span><span class="p">(</span><span class="n">MM_model</span><span class="p">),</span><span class="n">lty</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s">&quot;blue&quot;</span><span class="p">,</span><span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span> <span class="c1"># overlay the original model fit</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">S_data</span><span class="p">,</span><span class="nf">predict</span><span class="p">(</span><span class="n">MM_model3</span><span class="p">),</span><span class="n">lty</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s">&quot;red&quot;</span><span class="p">,</span><span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span> <span class="c1"># overlay the latest model fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_34_0.png" src="../_images/1-ModelFitting-NLLS_34_0.png" />
</div>
</div>
<p>As you would have guessed from the really funky coefficient estimates that were obtained in <code class="docutils literal notranslate"><span class="pre">MM_model3</span></code>, this is a pretty poor model fit to the data, with the negative value of <code class="docutils literal notranslate"><span class="pre">K_M</span></code> causing the fitted version of the Michaelis-Menten model to behave strangely.</p>
<p>Let’s try with even more different starting values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">nls</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">0.1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">nlsModel</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">wts</span><span class="p">):</span> <span class="n">singular</span> <span class="n">gradient</span> <span class="n">matrix</span> <span class="n">at</span> <span class="n">initial</span> <span class="n">parameter</span> <span class="n">estimates</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">nls</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span><span class="o">/</span><span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
 <span class="o">.</span>     <span class="n">K_M</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">))</span>
<span class="mi">2</span><span class="o">.</span> <span class="n">nlsModel</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">wts</span><span class="p">)</span>
<span class="mi">3</span><span class="o">.</span> <span class="n">stop</span><span class="p">(</span><span class="s2">&quot;singular gradient matrix at initial parameter estimates&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">singular</span> <span class="pre">gradient</span> <span class="pre">matrix</span> <span class="pre">at</span> <span class="pre">initial</span> <span class="pre">parameter</span> <span class="pre">estimates</span></code> error arises from the fact that the starting values you provided were so far from the optimal solution, that the parameter searching in <code class="docutils literal notranslate"><span class="pre">nls()</span></code> failed at the very first step. The algorithm could not figure out where to go from those starting values. In fact, the starting value we gave it is biologically/ physically impossible, because <code class="docutils literal notranslate"><span class="pre">V_max</span></code> can’t really equal 0.</p>
<p>Let’s look at some more starting values that can cause the model fitting to fail:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">nls</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">0.1</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">nls</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span><span class="o">/</span><span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="p">:</span> <span class="n">step</span> <span class="n">factor</span> <span class="mf">0.000488281</span> <span class="n">reduced</span> <span class="n">below</span> <span class="s1">&#39;minFactor&#39;</span> <span class="n">of</span> <span class="mf">0.000976562</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">nls</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span><span class="o">/</span><span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> 
 <span class="o">.</span>     <span class="n">K_M</span> <span class="o">=</span> <span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">nls</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">-0.1</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>In both the above cases, the model fitting was able to start, but eventually failed because the starting values were too far from the (approximately) optimal values (<span class="math notranslate nohighlight">\(V_{\max} \approx 13.5, K_M \approx 9.4\)</span>).</p>
<p>And what happens if we start really close to the optimal values? Let’s try:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">MM_model4</span> <span class="o">&lt;-</span> <span class="nf">nls</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">13.5</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">9.4</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">coef</span><span class="p">(</span><span class="n">MM_model</span><span class="p">)</span>
<span class="nf">coef</span><span class="p">(</span><span class="n">MM_model4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041180721635</dd><dt>K_M</dt><dd>9.40846157841925</dd></dl>
</div><div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041023449919</dd><dt>K_M</dt><dd>9.40841948575323</dd></dl>
</div></div>
</div>
<p>The results of the first model fit and this last one are still not exactly the same! This drives home the point that NLLS is not an “exact” procedure. However, the differences between these two solutions are minuscule, so the main thing to take away is that if the starting values are reasonable, NLLS is <em>exact enough</em>.</p>
<p>Note that and even if you started the NLLS fitting with the exact parameter values with which you generated the data before introducing errors (so use <code class="docutils literal notranslate"><span class="pre">start</span> <span class="pre">=</span> <span class="pre">list(V_max</span> <span class="pre">=</span> <span class="pre">12.5,</span> <span class="pre">K_M</span> <span class="pre">=</span> <span class="pre">7.1)</span></code> above instead), you would still get the same result for the coefficients (try it). This is because the NLLS fitting will converge back to the parameter estimates based on the actual data, errors and all.</p>
</div>
<div class="section" id="a-more-robust-nlls-algorithm">
<h2>A more robust NLLS algorithm<a class="headerlink" href="#a-more-robust-nlls-algorithm" title="Permalink to this headline">¶</a></h2>
<p>The standard NLLS function in R, <code class="docutils literal notranslate"><span class="pre">nls</span></code>, which we have been using so far, does the NLLS fitting by implementing an algorithm called the Gauss-Newton algorithm. While the Gauss-Newton algorithm works well for most simple non-linear models, it has a tendency to “get lost” or “stuck” while searching for optimal parameter estimates (that minimize the residual sum of squares, or RSS). Therefore, <code class="docutils literal notranslate"><span class="pre">nls</span></code> will often fail to fit your model to the data if you start off at starting values for the parameters that are too far from what the optimal values would be, as you saw above (e.g., when you got the <code class="docutils literal notranslate"><span class="pre">singular</span> <span class="pre">gradient</span> <span class="pre">matrix</span></code> error).</p>
<p>Some nonlinear models are especially difficult for nls to fit to data because such model have a mathematical form that makes it hard to find parameter combinations that minimize the residual sum of squared (RSS). If this does not makes sense, don’t worry about it.</p>
<p>One solution to this is to use a different algorithm than Gauss-Newton. <code class="docutils literal notranslate"><span class="pre">nls()</span></code> has one other algorithm that can be more robust in some situations, called the “port” algorithm. However, there is a better solution still: the Levenberg-Marqualdt algorithm, which is less likely to get stuck (is more robust than) than Gauss-Newton (or port). If you want to learn more about the technicalities of this, <a class="reference external" href="https://en.wikipedia.org/wiki/Gauss%E2%80%93Newton_algorithm">here</a> are <a class="reference external" href="https://en.wikipedia.org/wiki/Levenberg%E2%80%93Marquardt_algorithm">here</a> are good places to start (also see the Readings list at the end of this chapter).</p>
<p>To be able to use nlsLM, we will need to switch to a different NLLS function called <code class="docutils literal notranslate"><span class="pre">nlsLM</span></code>. In order to be able to use <code class="docutils literal notranslate"><span class="pre">nlsLM</span></code>, you will need the <code class="docutils literal notranslate"><span class="pre">nls.lm</span></code> R package, which you can install using the method appropriate for your operating system  (e.g., linux users will launch R in <code class="docutils literal notranslate"><span class="pre">sudo</span></code> mode first) and then use:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;minpack.lm&quot;</span><span class="p">)</span> 
</pre></div>
</div>
<p>Now load the <code class="docutils literal notranslate"><span class="pre">minpack.lm</span></code> package:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">require</span><span class="p">(</span><span class="s">&quot;minpack.lm&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s try it (using the same starting values as <code class="docutils literal notranslate"><span class="pre">MM_model2</span></code> above):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">MM_model5</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Now compare the <code class="docutils literal notranslate"><span class="pre">nls</span></code> and <code class="docutils literal notranslate"><span class="pre">nlsLM</span></code> fitted coefficients:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">coef</span><span class="p">(</span><span class="n">MM_model2</span><span class="p">)</span>
<span class="nf">coef</span><span class="p">(</span><span class="n">MM_model5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041046181521</dd><dt>K_M</dt><dd>9.40842557733051</dd></dl>
</div><div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041160772665</dd><dt>K_M</dt><dd>9.40845624487389</dd></dl>
</div></div>
</div>
<p>Close enough.</p>
<p>Now, let’s try fitting the model using all those starting parameter combinations that failed previously:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">MM_model6</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">MM_model7</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">0.1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">MM_model8</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">0.1</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">MM_model9</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">-0.1</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">coef</span><span class="p">(</span><span class="n">MM_model2</span><span class="p">)</span>
<span class="nf">coef</span><span class="p">(</span><span class="n">MM_model5</span><span class="p">)</span>
<span class="nf">coef</span><span class="p">(</span><span class="n">MM_model6</span><span class="p">)</span>
<span class="nf">coef</span><span class="p">(</span><span class="n">MM_model7</span><span class="p">)</span>
<span class="nf">coef</span><span class="p">(</span><span class="n">MM_model8</span><span class="p">)</span>
<span class="nf">coef</span><span class="p">(</span><span class="n">MM_model9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041046181521</dd><dt>K_M</dt><dd>9.40842557733051</dd></dl>
</div><div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041160772665</dd><dt>K_M</dt><dd>9.40845624487389</dd></dl>
</div><div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041188982262</dd><dt>K_M</dt><dd>9.40846378596541</dd></dl>
</div><div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>6.23550733765091</dd><dt>K_M</dt><dd>-1.39250725071091</dd></dl>
</div><div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041256272009</dd><dt>K_M</dt><dd>9.40848179662403</dd></dl>
</div><div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>V_max</dt><dd>13.5041149588841</dd><dt>K_M</dt><dd>9.40845325190657</dd></dl>
</div></div>
</div>
<p>Nice, these all worked with <code class="docutils literal notranslate"><span class="pre">nlsLM</span></code> even though they had failed with <code class="docutils literal notranslate"><span class="pre">nls</span></code>! But one of them (model 7) still gives you poor values for the coefficients.</p>
<p>But <code class="docutils literal notranslate"><span class="pre">nlsLM</span></code> also has its limits. Let’s try more absurd starting values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">nlsLM</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">-10</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">-10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">numericDeriv</span><span class="p">(</span><span class="n">form</span><span class="p">[[</span><span class="mi">3</span><span class="n">L</span><span class="p">]],</span> <span class="n">names</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="n">env</span><span class="p">):</span> <span class="n">Missing</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">infinity</span> <span class="n">produced</span> <span class="n">when</span> <span class="n">evaluating</span> <span class="n">the</span> <span class="n">model</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">nlsLM</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span><span class="o">/</span><span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> 
 <span class="o">.</span>     <span class="n">K_M</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="p">))</span>
<span class="mi">2</span><span class="o">.</span> <span class="n">nlsModel</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">wts</span><span class="p">)</span>
<span class="mi">3</span><span class="o">.</span> <span class="n">getRHS</span><span class="p">()</span>
<span class="mi">4</span><span class="o">.</span> <span class="n">numericDeriv</span><span class="p">(</span><span class="n">form</span><span class="p">[[</span><span class="mi">3</span><span class="n">L</span><span class="p">]],</span> <span class="n">names</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="n">env</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Thus, using starting values that are in a sensible range is always a good idea. Here, we know that neither <span class="math notranslate nohighlight">\(V_{\max}\)</span> nor <span class="math notranslate nohighlight">\(K_M\)</span> can be negative, so we can use that bit of information to assign reasonable starting values.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>How do you find “sensible” starting values for NLLS fitting?</em> This very much depends on your understanding of the mathematical model that is being fitted to the data, and the mechanistic interpretation of its parameters.</p>
</div>
</div>
<div class="section" id="bounding-parameter-values">
<span id="modelfitting-nlls-bounding"></span><h2>Bounding parameter values<a class="headerlink" href="#bounding-parameter-values" title="Permalink to this headline">¶</a></h2>
<p>You can also bound the starting values, i.e., prevent them from exceeding some minimum and maximum value <em>during</em> the NLLS fitting process:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">nlsLM</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Nonlinear regression model
  model: V_data ~ V_max * S_data/(K_M + S_data)
   data: parent.frame()
 V_max    K_M 
13.504  9.408 
 residual sum-of-squares: 48.06

Number of iterations to convergence: 9 
Achieved convergence tolerance: 1.49e-08
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">nlsLM</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">),</span> <span class="n">lower</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.4</span><span class="p">,</span><span class="m">0.4</span><span class="p">),</span> <span class="n">upper</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">100</span><span class="p">,</span><span class="m">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Nonlinear regression model
  model: V_data ~ V_max * S_data/(K_M + S_data)
   data: parent.frame()
 V_max    K_M 
13.504  9.408 
 residual sum-of-squares: 48.06

Number of iterations to convergence: 8 
Achieved convergence tolerance: 1.49e-08
</pre></div>
</div>
</div>
</div>
<p>So the solution was found in one lesser iteration (not a spectacular improvement, but an improvement nevertheless).</p>
<p>However, if you bound the parameters too much (to excessively narrow ranges), the algorithm cannot search sufficient parameter space (combinations of parameters), and will fail to converge on a good solution. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">nlsLM</span><span class="p">(</span><span class="n">V_data</span> <span class="o">~</span> <span class="n">V_max</span> <span class="o">*</span> <span class="n">S_data</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_M</span> <span class="o">+</span> <span class="n">S_data</span><span class="p">),</span> <span class="n">start</span> <span class="o">=</span>  <span class="nf">list</span><span class="p">(</span><span class="n">V_max</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span> <span class="n">K_M</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">),</span> <span class="n">lower</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.4</span><span class="p">,</span><span class="m">0.4</span><span class="p">),</span> <span class="n">upper</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">20</span><span class="p">,</span><span class="m">20</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Nonlinear regression model
  model: V_data ~ V_max * S_data/(K_M + S_data)
   data: parent.frame()
V_max   K_M 
17.21 20.00 
 residual sum-of-squares: 78.58

Number of iterations to convergence: 3 
Achieved convergence tolerance: 1.49e-08
</pre></div>
</div>
</div>
</div>
<p>Here the algorithm converged on a poor solution, and in fact took fewer iterations (3) than before to do so. This is because it could not explore sufficient parameter combinations of <code class="docutils literal notranslate"><span class="pre">V_max</span></code> and <code class="docutils literal notranslate"><span class="pre">K_M</span></code> as we have narrowed the range that both these parameters could be allowed to take during the optimization too much.</p>
</div>
<div class="section" id="diagnostics-of-an-nlls-fit">
<h2>Diagnostics of an NLLS fit<a class="headerlink" href="#diagnostics-of-an-nlls-fit" title="Permalink to this headline">¶</a></h2>
<p>NLLS regression carries the same three key assumptions as Linear models:</p>
<ul class="simple">
<li><p>No (in practice, minimal) measurement error in explanatory/independent/predictor variable (<span class="math notranslate nohighlight">\(x\)</span>-axis variable)</p></li>
<li><p>Data have constant normal variance — errors in the <span class="math notranslate nohighlight">\(y\)</span>-axis are homogeneously distributed over the <span class="math notranslate nohighlight">\(x\)</span>-axis range</p></li>
<li><p>The measurement/observation errors are Normally distributed (Gaussian)</p></li>
</ul>
<p>At the very least, it is a good idea to plot the residuals of a fitted NLLS model. Let’s do that for our Michaelis-Menten Model fit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">hist</span><span class="p">(</span><span class="nf">residuals</span><span class="p">(</span><span class="n">MM_model6</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_68_0.png" src="../_images/1-ModelFitting-NLLS_68_0.png" />
</div>
</div>
<p>The residuals look OK. But this should not come as a surprise because we generated these “data” ourselves using normally-distributed errors!</p>
<p>You may also want to look at further diagnostics, as we did <a class="reference external" href="14-regress:Diagnostics">previously</a> in the case of Linear models. The most convenient way to do this is to use the <code class="docutils literal notranslate"><span class="pre">nlstools</span></code> package. We will not go into it here, but you can have a look at its <a class="reference external" href="https://rdrr.io/rforge/nlstools/">documentation</a>. Note that you will need to install this package as it is not one of the core (base) R packages.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For the remaining examples, we will switch to using <code class="docutils literal notranslate"><span class="pre">nlsLM</span></code> instead of <code class="docutils literal notranslate"><span class="pre">nls</span></code>.</p>
</div>
</div>
<div class="section" id="allometric-scaling-of-traits">
<h2>Allometric scaling of traits<a class="headerlink" href="#allometric-scaling-of-traits" title="Permalink to this headline">¶</a></h2>
<p>Now let’s move on to a very common class of traits in biology: physical traits like body weight, wing span, body length, limb length, eye size, ear width, etc.</p>
<p>We will look at a very common phenomenon called <a class="reference external" href="https://en.wikipedia.org/wiki/Allometry">allometric scaling</a>. Allometric relationships between linear measurements such as body length, limb length, wing span, and thorax width are a good way to obtain estimates of body weights of individual organisms. We will look at allometric scaling of body weight vs. total body length in dragonflies and damselfiles.</p>
<p>Allometric relationships take the form:</p>
<div class="math notranslate nohighlight" id="equation-eq-allom">
<span class="eqno">()<a class="headerlink" href="#equation-eq-allom" title="Permalink to this equation">¶</a></span>\[
y = a x^b
\]</div>
<p>where <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> are morphological measures (body length and body weight respectively, in our current example), the constant is the value of <span class="math notranslate nohighlight">\(y\)</span> at body length <span class="math notranslate nohighlight">\(x = 1\)</span> unit, and <span class="math notranslate nohighlight">\(b\)</span> is the scaling “exponent”. This is also called a power-law, because <span class="math notranslate nohighlight">\(y\)</span> relates to <span class="math notranslate nohighlight">\(x\)</span> through a simple power.</p>
<p>Let’s fit a power low to a typical allometric relationship: The change in body weight vs change in body length. In general, this relationship is a allometry; that is, body weight does not increase proportionally with some measure of body length.</p>
<p>First, let’s look at the data. You can get the data <a class="reference external" href="https://raw.githubusercontent.com/mhasoba/TheMulQuaBio/master/content/data/GenomeSize.csv">here</a> (first click on link and use “Save as” or <code class="docutils literal notranslate"><span class="pre">Ctrl+S</span></code> to download it as a csv).</p>
<p><span class="math notranslate nohighlight">\(\star\)</span> Save the <code class="docutils literal notranslate"><span class="pre">GenomeSize.csv</span></code> data file to your <code class="docutils literal notranslate"><span class="pre">data</span></code> directory, and import it into your R workspace:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">MyData</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&quot;../data/GenomeSize.csv&quot;</span><span class="p">)</span> <span class="c1"># using relative path assuming that your working directory is &quot;code&quot;</span>

<span class="nf">head</span><span class="p">(</span><span class="n">MyData</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A data.frame: 6 × 16</caption>
<thead>
	<tr><th></th><th scope=col>Suborder</th><th scope=col>Family</th><th scope=col>Species</th><th scope=col>GenomeSize</th><th scope=col>GenomeSE</th><th scope=col>GenomeN</th><th scope=col>BodyWeight</th><th scope=col>TotalLength</th><th scope=col>HeadLength</th><th scope=col>ThoraxLength</th><th scope=col>AdbdomenLength</th><th scope=col>ForewingLength</th><th scope=col>HindwingLength</th><th scope=col>ForewingArea</th><th scope=col>HindwingArea</th><th scope=col>MorphologyN</th></tr>
	<tr><th></th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>Anisoptera</td><td>Aeshnidae</td><td>Aeshna canadensis   </td><td>2.20</td><td>  NA</td><td>1</td><td>0.159</td><td>67.58</td><td>6.83</td><td>11.81</td><td>48.94</td><td>45.47</td><td>45.40</td><td>369.57</td><td>483.61</td><td>2</td></tr>
	<tr><th scope=row>2</th><td>Anisoptera</td><td>Aeshnidae</td><td>Aeshna constricta   </td><td>1.76</td><td>0.06</td><td>4</td><td>0.228</td><td>71.97</td><td>6.84</td><td>10.72</td><td>54.41</td><td>46.00</td><td>45.48</td><td>411.15</td><td>517.38</td><td>3</td></tr>
	<tr><th scope=row>3</th><td>Anisoptera</td><td>Aeshnidae</td><td>Aeshna eremita      </td><td>1.85</td><td>  NA</td><td>1</td><td>0.312</td><td>78.80</td><td>6.27</td><td>16.19</td><td>56.33</td><td>51.24</td><td>49.47</td><td>460.72</td><td>574.33</td><td>1</td></tr>
	<tr><th scope=row>4</th><td>Anisoptera</td><td>Aeshnidae</td><td>Aeshna tuberculifera</td><td>1.78</td><td>0.10</td><td>2</td><td>0.218</td><td>72.44</td><td>6.62</td><td>12.53</td><td>53.29</td><td>49.84</td><td>48.82</td><td>468.74</td><td>591.42</td><td>2</td></tr>
	<tr><th scope=row>5</th><td>Anisoptera</td><td>Aeshnidae</td><td>Aeshna umbrosa      </td><td>2.00</td><td>  NA</td><td>1</td><td>0.207</td><td>73.05</td><td>4.92</td><td>11.11</td><td>57.03</td><td>46.51</td><td>45.97</td><td>382.48</td><td>481.44</td><td>1</td></tr>
	<tr><th scope=row>6</th><td>Anisoptera</td><td>Aeshnidae</td><td>Aeshna verticalis   </td><td>1.59</td><td>  NA</td><td>1</td><td>0.220</td><td>66.25</td><td>6.48</td><td>11.64</td><td>48.13</td><td>45.91</td><td>44.91</td><td>400.40</td><td>486.97</td><td>1</td></tr>
</tbody>
</table>
</div></div>
</div>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Dragonfly">Anisoptera</a> are dragonflies, and <a class="reference external" href="https://en.wikipedia.org/wiki/Damselfly">Zygoptera</a> are Damselflies. The variables of interest are <code class="docutils literal notranslate"><span class="pre">BodyWeight</span></code> and <code class="docutils literal notranslate"><span class="pre">TotalLength</span></code>. Let’s use the dragonflies data subset.</p>
<p>So subset the data accordingly and remove NAs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Data2Fit</span> <span class="o">&lt;-</span> <span class="nf">subset</span><span class="p">(</span><span class="n">MyData</span><span class="p">,</span><span class="n">Suborder</span> <span class="o">==</span> <span class="s">&quot;Anisoptera&quot;</span><span class="p">)</span>

<span class="n">Data2Fit</span> <span class="o">&lt;-</span> <span class="n">Data2Fit</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">TotalLength</span><span class="p">),]</span> <span class="c1"># remove NA&#39;s</span>
</pre></div>
</div>
</div>
</div>
<p>Plot the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">TotalLength</span><span class="p">,</span> <span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="s">&quot;Body Length&quot;</span><span class="p">,</span> <span class="n">ylab</span> <span class="o">=</span> <span class="s">&quot;Body Weight&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_80_0.png" src="../_images/1-ModelFitting-NLLS_80_0.png" />
</div>
</div>
<p>Or, using <code class="docutils literal notranslate"><span class="pre">ggplot</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="s">&quot;ggplot2&quot;</span><span class="p">)</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">Data2Fit</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">TotalLength</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">BodyWeight</span><span class="p">))</span> <span class="o">+</span> 
<span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="m">3</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;red&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span> 
<span class="nf">labs</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s">&quot;Body mass (mg)&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s">&quot;Wing length (mm)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_82_0.png" src="../_images/1-ModelFitting-NLLS_82_0.png" />
</div>
</div>
<p>You can see these body weights of dragonflies does not increase proportionally with body length – they curve upwards w.r.t. wing length (so the allometric constant <span class="math notranslate nohighlight">\(b\)</span> in eqn <a class="reference internal" href="#equation-eq-allom">()</a> mustbe greater than 1), instead of increasing as a straight line (in which case <span class="math notranslate nohighlight">\(b = 1\)</span> (isometry, instead of allometry).</p>
<p>Now fit the model to the data using NLLS:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">PowFit</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">BodyWeight</span> <span class="o">~</span> <span class="n">a</span> <span class="o">*</span> <span class="n">TotalLength</span><span class="o">^</span><span class="n">b</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">Data2Fit</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">.</span><span class="m">1</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">.</span><span class="m">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The first thing to do is to see how well the model fitted the data, for which plotting is the best first option. So let’s visualize the fit. For this, first we need to generate a vector of body lengths (the x-axis variable) for plotting:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Lengths</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">TotalLength</span><span class="p">),</span><span class="nf">max</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">TotalLength</span><span class="p">),</span><span class="n">len</span><span class="o">=</span><span class="m">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">coef</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)[</span><span class="s">&quot;a&quot;</span><span class="p">]</span>
<span class="nf">coef</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)[</span><span class="s">&quot;b&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><strong>a:</strong> 3.94068495559397e-06</div><div class="output text_html"><strong>b:</strong> 2.58504796499038</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Predic2PlotPow</span> <span class="o">&lt;-</span> <span class="nf">powMod</span><span class="p">(</span><span class="n">Lengths</span><span class="p">,</span><span class="nf">coef</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)[</span><span class="s">&quot;a&quot;</span><span class="p">],</span><span class="nf">coef</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)[</span><span class="s">&quot;b&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">powMod</span><span class="p">(</span><span class="n">Lengths</span><span class="p">,</span> <span class="n">coef</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="n">coef</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)[</span><span class="s2">&quot;b&quot;</span><span class="p">]):</span> <span class="n">could</span> <span class="ow">not</span> <span class="n">find</span> <span class="n">function</span> <span class="s2">&quot;powMod&quot;</span>
<span class="ne">Traceback</span>:
</pre></div>
</div>
</div>
</div>
<p>Next, calculate the predicted line. For this, we will need to extract the coefficient from the model fit object using the <code class="docutils literal notranslate"><span class="pre">coef()</span></code>command.</p>
<p>Now plot the data and the fitted model line:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">TotalLength</span><span class="p">,</span> <span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">Lengths</span><span class="p">,</span> <span class="n">Predic2PlotPow</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">lwd</span> <span class="o">=</span> <span class="m">2.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">xy</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> <span class="nb">object</span> <span class="s1">&#39;Predic2PlotPow&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">lines</span><span class="p">(</span><span class="n">Lengths</span><span class="p">,</span> <span class="n">Predic2PlotPow</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">lwd</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="mi">2</span><span class="o">.</span> <span class="n">lines</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">Lengths</span><span class="p">,</span> <span class="n">Predic2PlotPow</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">lwd</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="mi">3</span><span class="o">.</span> <span class="n">plot</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">xy</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="mi">4</span><span class="o">.</span> <span class="n">xy</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/1-ModelFitting-NLLS_92_1.png" src="../_images/1-ModelFitting-NLLS_92_1.png" />
</div>
</div>
<p>Now lets get some stats of this NLLS fit. Having obtained the fit object (<code class="docutils literal notranslate"><span class="pre">PowMod</span></code>), we can use <code class="docutils literal notranslate"><span class="pre">summary()</span></code> just like we would for a <code class="docutils literal notranslate"><span class="pre">lm()</span></code> fit object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">summary</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Formula: BodyWeight ~ a * TotalLength^b

Parameters:
   Estimate Std. Error t value Pr(&gt;|t|)    
a 3.941e-06  2.234e-06   1.764    0.083 .  
b 2.585e+00  1.348e-01  19.174   &lt;2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.02807 on 58 degrees of freedom

Number of iterations to convergence: 39 
Achieved convergence tolerance: 1.49e-08
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="nlls-fitting-using-model-objects">
<h2>NLLS fitting using model objects<a class="headerlink" href="#nlls-fitting-using-model-objects" title="Permalink to this headline">¶</a></h2>
<p>Another way to tell <code class="docutils literal notranslate"><span class="pre">nlsLM</span></code> which model to fit, is to first create a function object for the power law model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">powMod</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
 <span class="nf">return</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="o">^</span><span class="n">b</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Now fit the model to the data using NLLS by calling the model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">PowFit</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">BodyWeight</span> <span class="o">~</span> <span class="nf">powMod</span><span class="p">(</span><span class="n">TotalLength</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">Data2Fit</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">.</span><span class="m">1</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">.</span><span class="m">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Which gives the same result as before (you can check it).</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Remember, when you write this analysis into a stand-alone R script, you should put all commands for loading packages (<code class="docutils literal notranslate"><span class="pre">library()</span></code>, <code class="docutils literal notranslate"><span class="pre">require()</span></code>) at the start of the script. *</p>
</div>
<div class="section" id="exercises-a-id-allom-exercises-a">
<h3>Exercises <a id='Allom_Exercises'></a><a class="headerlink" href="#exercises-a-id-allom-exercises-a" title="Permalink to this headline">¶</a></h3>
<p>(a) Make the same plot as above, fitted line and all, in <code class="docutils literal notranslate"><span class="pre">ggplot</span></code>, and add (display) the equation you estimated to your new (ggplot) plot. The equation is: <span class="math notranslate nohighlight">\(\text{Weight} = 3.94 \times 10^{-06} \times \text{Length}^{2.59}\)</span></p>
<p>(b) Try playing with the starting values, and see if you can “break” the model fitting – that is, change the starting values till the NLLS fitting does not converge on a solution.</p>
<p>(c) Repeat the model fitting (including a-b above) using the Zygoptera data subset.</p>
<p>(d) There is an alternative (and in fact, more commonly-used) approach for fitting the allometric model to data: using Ordinary Least Squares on bi-logarithamically transformed data. That is, if you take a log of both sides of the <a class="reference external" href="#eq:allom">allometric equation</a> we get,</p>
<div class="math notranslate nohighlight">
\[
\log(y) = \log(a) + b \log(x)
\]</div>
<p>This is a straight line equation of the form <span class="math notranslate nohighlight">\(c = d + b z \)</span>, where <span class="math notranslate nohighlight">\(c = \log(c)\)</span>, <span class="math notranslate nohighlight">\(d = \log(a)\)</span>, <span class="math notranslate nohighlight">\(z = \log(x)\)</span>, and <span class="math notranslate nohighlight">\(b\)</span> is now the slope parameter. So you can use Ordinary Least Squares and the linear models framework (with <code class="docutils literal notranslate"><span class="pre">lm()</span></code>) in R to estimate the parameters of the allometric equation.</p>
<p>In this exercise, try comparing the NLLS vs OLS methods to see how much difference you get in the parameter estimates between them. For example, see the methods used in this paper by <a class="reference external" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3465447/">Cohen et al 2012</a>.</p>
<p>(e) The allometry between Body weight and Length is not the end of the story. You have a number of other linear morphological measurements (<code class="docutils literal notranslate"><span class="pre">HeadLength</span></code>, <code class="docutils literal notranslate"><span class="pre">ThoraxLength</span></code>, <code class="docutils literal notranslate"><span class="pre">AdbdomenLength</span></code>, <code class="docutils literal notranslate"><span class="pre">ForewingLength</span></code>, <code class="docutils literal notranslate"><span class="pre">HindwingLength</span></code>, <code class="docutils literal notranslate"><span class="pre">ForewingArea</span></code>, and <code class="docutils literal notranslate"><span class="pre">HindwingArea</span></code>) that can also be investigated. In this exercise, try two lines of investigation (again, repeated separately for Dragonflies and Damselfiles):</p>
<p>(i) How do each of these measures allometrically scale with Body length (obtain estimates of scaling constant and exponent)? (Hint: you may want to use the <code class="docutils literal notranslate"><span class="pre">pairs()</span></code> command in R to get an overview of all the pairs of potential scaling relationships.</p>
<p>(ii) Do any of the linear morphological measurements other than body length better predict Body weight? That is, does body weight scale more tightly with a linear morphological measurement other than total body length? You would use model selection here, which we will learn next. But for now, you can just look at and compare the <span class="math notranslate nohighlight">\(R^2\)</span> values of the models.</p>
</div>
</div>
<div class="section" id="comparing-models">
<span id="model-fitting-r-comparing-models"></span><h2>Comparing models<a class="headerlink" href="#comparing-models" title="Permalink to this headline">¶</a></h2>
<p><em>How do we know that there isn’t a better or alternative model that adequately explains the pattern in your dataset?</em></p>
<p>This is important consideration in all data analyses (and more generally, the scientific method!), so you must aim to compare your NLLS model with an one or more alternatives for a more extensive and reliable investigation of the problem.</p>
<p>Let’s use model comparison to investigate whether the relationship between body weight and length we found above is indeed allometric. For this, we need an alternative model that can be fitted to the same data. Let’s try a quadratic curve, which is of the form:</p>
<div class="math notranslate nohighlight">
\[
y = a + b x + c x^2
\]</div>
<p>This can also capture curvature in data, and is an alternative model to the <a class="reference external" href="#eq:allom">allometric equation</a>. Note that this mode is linear in its parameters (a linear model), which you can fit to the simply data using your familiar <code class="docutils literal notranslate"><span class="pre">lm()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">QuaFit</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">BodyWeight</span> <span class="o">~</span> <span class="nf">poly</span><span class="p">(</span><span class="n">TotalLength</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">Data2Fit</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And like before, we obtain the predicted values (but this time using the <code class="docutils literal notranslate"><span class="pre">predict.lm</span></code> function):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Predic2PlotQua</span> <span class="o">&lt;-</span> <span class="nf">predict.lm</span><span class="p">(</span><span class="n">QuaFit</span><span class="p">,</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">TotalLength</span> <span class="o">=</span> <span class="n">Lengths</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s plot the two fitted models together:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">TotalLength</span><span class="p">,</span> <span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">Lengths</span><span class="p">,</span> <span class="n">Predic2PlotPow</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">lwd</span> <span class="o">=</span> <span class="m">2.5</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">Lengths</span><span class="p">,</span> <span class="n">Predic2PlotQua</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">lwd</span> <span class="o">=</span> <span class="m">2.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">xy</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> <span class="nb">object</span> <span class="s1">&#39;Predic2PlotPow&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">lines</span><span class="p">(</span><span class="n">Lengths</span><span class="p">,</span> <span class="n">Predic2PlotPow</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">lwd</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="mi">2</span><span class="o">.</span> <span class="n">lines</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">Lengths</span><span class="p">,</span> <span class="n">Predic2PlotPow</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">lwd</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="mi">3</span><span class="o">.</span> <span class="n">plot</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">xy</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="mi">4</span><span class="o">.</span> <span class="n">xy</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/1-ModelFitting-NLLS_107_1.png" src="../_images/1-ModelFitting-NLLS_107_1.png" />
</div>
</div>
<p>Very similar fits, except that the quadratic model seems to deviate a bit from the data at the lower end of the data range. Let’s do a proper, formal model comparison now to check which model better-fits the data.</p>
<p>First calculate the R<span class="math notranslate nohighlight">\(^2\)</span> values of the two fitted models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">RSS_Pow</span> <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">(</span><span class="nf">residuals</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="c1"># Residual sum of squares</span>
<span class="n">TSS_Pow</span> <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">((</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span> <span class="o">-</span> <span class="nf">mean</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span><span class="p">))</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="c1"># Total sum of squares</span>
<span class="n">RSq_Pow</span> <span class="o">&lt;-</span> <span class="m">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">RSS_Pow</span><span class="o">/</span><span class="n">TSS_Pow</span><span class="p">)</span> <span class="c1"># R-squared value</span>

<span class="n">RSS_Qua</span> <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">(</span><span class="nf">residuals</span><span class="p">(</span><span class="n">QuaFit</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="c1"># Residual sum of squares</span>
<span class="n">TSS_Qua</span> <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">((</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span> <span class="o">-</span> <span class="nf">mean</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span><span class="p">))</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="c1"># Total sum of squares</span>
<span class="n">RSq_Qua</span> <span class="o">&lt;-</span> <span class="m">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">RSS_Qua</span><span class="o">/</span><span class="n">TSS_Qua</span><span class="p">)</span> <span class="c1"># R-squared value</span>

<span class="n">RSq_Pow</span> 
<span class="n">RSq_Qua</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.90054752976309</div><div class="output text_html">0.900302864503218</div></div>
</div>
<p>Not very useful. In general, R<span class="math notranslate nohighlight">\(^2\)</span> is a good measure of model fit, but cannot be used for model selection – especially not here, given the tiny difference in R<span class="math notranslate nohighlight">\(^2\)</span>’s.</p>
<p>Instead, as explained in the <a class="reference external" href="https://github.com/mhasoba/TheMulQuaBio/blob/master/lectures/ModelFitting">lecture</a>, we can use the Akaike Information Criterion (AIC):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">Data2Fit</span><span class="p">)</span> <span class="c1">#set sample size</span>
<span class="n">pPow</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="nf">coef</span><span class="p">(</span><span class="n">PowFit</span><span class="p">))</span> <span class="c1"># get number of parameters in power law model</span>
<span class="n">pQua</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="nf">coef</span><span class="p">(</span><span class="n">QuaFit</span><span class="p">))</span> <span class="c1"># get number of parameters in quadratic model</span>

<span class="n">AIC_Pow</span> <span class="o">&lt;-</span> <span class="n">n</span> <span class="o">+</span> <span class="m">2</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="nf">log</span><span class="p">((</span><span class="m">2</span> <span class="o">*</span> <span class="kc">pi</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="nf">log</span><span class="p">(</span><span class="n">RSS_Pow</span><span class="p">)</span> <span class="o">+</span> <span class="m">2</span> <span class="o">*</span> <span class="n">pPow</span>
<span class="n">AIC_Qua</span> <span class="o">&lt;-</span> <span class="n">n</span> <span class="o">+</span> <span class="m">2</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="nf">log</span><span class="p">((</span><span class="m">2</span> <span class="o">*</span> <span class="kc">pi</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="nf">log</span><span class="p">(</span><span class="n">RSS_Qua</span><span class="p">)</span> <span class="o">+</span> <span class="m">2</span> <span class="o">*</span> <span class="n">pQua</span>
<span class="n">AIC_Pow</span> <span class="o">-</span> <span class="n">AIC_Qua</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">-2.14742608125084</div></div>
</div>
<p>Of course, as you might have suspected, we can do this using an in-built function in R!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">AIC</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)</span> <span class="o">-</span> <span class="nf">AIC</span><span class="p">(</span><span class="n">QuaFit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">-2.1474260812509</div></div>
</div>
<ul class="simple">
<li><p>So which model wins? * As we had dicussed in the NLLS lecture, a rule of thumb is that a AIC value difference (typically denoted as <span class="math notranslate nohighlight">\(\Delta\)</span>AIC) &gt; 2 is a acceptable cutoff for calling a winner. So the power law (allometric model) is a better fit here. Read the <a class="reference external" href="https://github.com/mhasoba/TheMulQuaBio/blob/master/readings/Modelling/JohnsonOmland2004.pdf">Johnson &amp; Omland paper</a> for more on model selection in Ecology and Evolution.</p></li>
</ul>
<div class="section" id="exercises-a-id-modelselection-exercises-a">
<h3>Exercises <a id='ModelSelection_Exercises'></a><a class="headerlink" href="#exercises-a-id-modelselection-exercises-a" title="Permalink to this headline">¶</a></h3>
<p>(a) Calculate the Bayesian Information Criterion (BIC), also know as the Schwarz Criterion (see your Lecture notes and the <a class="reference external" href="https://github.com/mhasoba/TheMulQuaBio/blob/master/readings/Modelling/JohnsonOmland2004.pdf">Johnson &amp; Omland paper</a>, and use <span class="math notranslate nohighlight">\(\Delta\)</span>BIC to select the better fitting model.</p>
<p>(b) Fit a straight line to the same data and compare with the allometric and quadratic models.</p>
<p>(c) Repeat the model comparison (incuding 1-2 above) using the Damselflies (Zygoptera) data subset – does the allometric model still win?</p>
<p>(d) Repeat exercise (e)(i) and (ii) from the <a class="reference external" href="#Allom_Exercises">above set</a>, but with model comparison (e.g., again using a quadratic as an alternative model) to establish that the relationships are indeed allometric.</p>
<p>(e) Repeat exercise (e)(ii) from the <a class="reference external" href="#Allom_Exercises">above set</a>, but with model comparison to establish which linear measurement is the best predictor of Body weight.</p>
</div>
</div>
<div class="section" id="albatross-chick-growth">
<h2>Albatross chick growth<a class="headerlink" href="#albatross-chick-growth" title="Permalink to this headline">¶</a></h2>
<p>Now let’s look at a different trait example: the growth of an individual albatross chick (you can find similar data for vector and non-vector arthropods in <a class="reference external" href="https://vectorbyte.org/">VecTraits</a>). First load and plot the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">alb</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="s">&quot;../data/albatross_grow.csv&quot;</span><span class="p">)</span>
<span class="n">alb</span> <span class="o">&lt;-</span> <span class="nf">subset</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">alb</span><span class="p">,</span> <span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">wt</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">age</span><span class="p">,</span> <span class="n">alb</span><span class="o">$</span><span class="n">wt</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;age (days)&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;weight (g)&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_117_0.png" src="../_images/1-ModelFitting-NLLS_117_0.png" />
</div>
</div>
<div class="section" id="fitting-the-three-models-using-nlls">
<h3>Fitting the three models using NLLS<a class="headerlink" href="#fitting-the-three-models-using-nlls" title="Permalink to this headline">¶</a></h3>
<p>Let’s fit multiple models to this dataset.</p>
<p>The Von Bertalanffy model is commonly used for modelling the growth of an individual. It’s formulation is:</p>
<div class="math notranslate nohighlight">
\[
W(t) = \rho (L_{\infty}(1-e^{-Kt})+L_0 e^{-Kt})^3
\]</div>
<p>If we pull out <span class="math notranslate nohighlight">\(L_{\infty}\)</span> and define <span class="math notranslate nohighlight">\(c=L_0/L_{\infty}\)</span> and <span class="math notranslate nohighlight">\(W_{\infty}=\rho L_{\infty}^3\)</span> this equation becomes:</p>
<div class="math notranslate nohighlight">
\[
W(t) = W_{\infty}(1-e^{-Kt}+ c e^{-Kt})^3.
\]</div>
<p><span class="math notranslate nohighlight">\(W_{\infty}\)</span> is interpreted as the mean asymptotic weight, and <span class="math notranslate nohighlight">\(c\)</span> the ratio between the initial and final lengths. This second equation is the one we will fit.</p>
<p>We will compare this model against the classical Logistic growth equation and a straight line.</p>
<p>The logistic equation is:</p>
<div class="math notranslate nohighlight">
\[
N_t = \frac{N_0 K e^{r t}}{K + N_0 (e^{r t} - 1)}
\]</div>
<p>Here <span class="math notranslate nohighlight">\(N_t\)</span> is population size at time <span class="math notranslate nohighlight">\(t\)</span>, <span class="math notranslate nohighlight">\(N_0\)</span> is initial population size, <span class="math notranslate nohighlight">\(r\)</span> is maximum growth rate (AKA <span class="math notranslate nohighlight">\(r_\text{max}\)</span>), and <span class="math notranslate nohighlight">\(K\)</span> is carrying capacity.</p>
<p>First, as we did before, let’s define the R functions for the two models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">logistic1</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">N0</span><span class="p">){</span>
 <span class="n">N0</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="nf">exp</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">K</span><span class="o">+</span><span class="n">N0</span> <span class="o">*</span> <span class="p">(</span><span class="nf">exp</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span><span class="m">-1</span><span class="p">))</span>
<span class="p">}</span>

<span class="n">vonbert.w</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Winf</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">K</span><span class="p">){</span>
 <span class="n">Winf</span> <span class="o">*</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> <span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">K</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">K</span> <span class="o">*</span> <span class="n">t</span><span class="p">))</span><span class="o">^</span><span class="m">3</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>For the straight line, we use simply use R’s <code class="docutils literal notranslate"><span class="pre">lm()</span></code> function, as that is a linear least squares problem. Using NLLS will give (approximately) the same answer, of course. Now fit all 3 models using least squares.</p>
<p>We will scale the data before fitting to improve the stability of the estimates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">scale</span> <span class="o">&lt;-</span> <span class="m">4000</span>

<span class="n">alb.lin</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">wt</span><span class="o">/</span><span class="n">scale</span> <span class="o">~</span> <span class="n">age</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">alb</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">alb.log</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">wt</span><span class="o">/</span><span class="n">scale</span><span class="o">~</span><span class="nf">logistic1</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">N0</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="m">0.1</span><span class="p">,</span> <span class="n">N0</span><span class="o">=</span><span class="m">0.1</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">alb</span><span class="p">)</span>

<span class="n">alb.vb</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">wt</span><span class="o">/</span><span class="n">scale</span><span class="o">~</span><span class="nf">vonbert.w</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">Winf</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">K</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">Winf</span><span class="o">=</span><span class="m">0.75</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="m">0.01</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="m">0.01</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">alb</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next let’s calculate predictions for each of the models across a range of ages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">ages</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="m">1000</span><span class="p">)</span>

<span class="n">pred.lin</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">alb.lin</span><span class="p">,</span> <span class="n">newdata</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="n">ages</span><span class="p">))</span> <span class="o">*</span> <span class="n">scale</span>

<span class="n">pred.log</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">alb.log</span><span class="p">,</span> <span class="n">newdata</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="n">ages</span><span class="p">))</span> <span class="o">*</span> <span class="n">scale</span>

<span class="n">pred.vb</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">alb.vb</span><span class="p">,</span> <span class="n">newdata</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="n">ages</span><span class="p">))</span> <span class="o">*</span> <span class="n">scale</span>
</pre></div>
</div>
</div>
</div>
<p>And finally plot the data with the fits:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">age</span><span class="p">,</span> <span class="n">alb</span><span class="o">$</span><span class="n">wt</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;age (days)&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;weight (g)&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">100</span><span class="p">))</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">pred.lin</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">pred.log</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">pred.vb</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>

<span class="nf">legend</span><span class="p">(</span><span class="s">&quot;topleft&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;linear&quot;</span><span class="p">,</span> <span class="s">&quot;logistic&quot;</span><span class="p">,</span> <span class="s">&quot;Von Bert&quot;</span><span class="p">),</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lty</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="m">2</span><span class="o">:</span><span class="m">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_126_0.png" src="../_images/1-ModelFitting-NLLS_126_0.png" />
</div>
</div>
<p>Next examine the residuals between the 3 models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">bty</span><span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">age</span><span class="p">,</span> <span class="nf">resid</span><span class="p">(</span><span class="n">alb.lin</span><span class="p">),</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;LM resids&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">100</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">age</span><span class="p">,</span> <span class="nf">resid</span><span class="p">(</span><span class="n">alb.log</span><span class="p">),</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;Logisitic resids&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">100</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">age</span><span class="p">,</span> <span class="nf">resid</span><span class="p">(</span><span class="n">alb.vb</span><span class="p">),</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;VB resids&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_128_0.png" src="../_images/1-ModelFitting-NLLS_128_0.png" />
</div>
</div>
<p>The residuals for all 3 models still exhibit some patterns. In particular, the data seems to go down near the end of the observation period, but none of these models can capture that behavior.</p>
<p>Finally, let’s compare the 3 models using a simpler approach than the AIC/BIC one that we used <a class="reference external" href="#Allom_Exercises">above</a> by calculating adjusted Sums of Squared Errors (SSE’s):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">wt</span><span class="p">)</span>
<span class="nf">list</span><span class="p">(</span><span class="n">lin</span><span class="o">=</span><span class="nf">signif</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="nf">resid</span><span class="p">(</span><span class="n">alb.lin</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="m">-2</span> <span class="o">*</span> <span class="m">2</span><span class="p">),</span> <span class="m">3</span><span class="p">),</span> 
 <span class="n">log</span><span class="o">=</span> <span class="nf">signif</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="nf">resid</span><span class="p">(</span><span class="n">alb.log</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="m">-2</span> <span class="o">*</span> <span class="m">3</span><span class="p">),</span> <span class="m">3</span><span class="p">),</span> 
 <span class="n">vb</span><span class="o">=</span> <span class="nf">signif</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="nf">resid</span><span class="p">(</span><span class="n">alb.vb</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="m">-2</span> <span class="o">*</span> <span class="m">3</span><span class="p">),</span> <span class="m">3</span><span class="p">))</span>   
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><dl>
	<dt>$lin</dt>
		<dd>0.00958</dd>
	<dt>$log</dt>
		<dd>0.0056</dd>
	<dt>$vb</dt>
		<dd>0.00628</dd>
</dl>
</div></div>
</div>
<p>The adjusted SSE accounts for sample size and number of parameters by dividing the RSS by the residual degrees of freedom. Adjusted SSE can also be used for model selection like AIC/BIC (but is less robust than AIC/BIC). The residual degrees of freedom is calculated as the number of response values (sample size, <span class="math notranslate nohighlight">\(n\)</span>) minus 2, times the number of fitted coefficients <span class="math notranslate nohighlight">\(m\)</span> (= 2 or 3 in this case) estimated.</p>
<p>The logistic model has the lowest adjusted SSE, so it’s the best by this measure. It is also, visually, a better fit.</p>
</div>
<div class="section" id="exercises-a-id-albatross-exercises-a">
<h3>Exercises <a id='Albatross_Exercises'></a><a class="headerlink" href="#exercises-a-id-albatross-exercises-a" title="Permalink to this headline">¶</a></h3>
<p>(a) Use AIC/BIC to perform model selection on the Albatross data as we did for the trait allometry example.</p>
<p>(b) Write this example as a self-sufficient R script, with ggplot istead of base plotting</p>
</div>
</div>
<div class="section" id="aedes-aegypti-fecundity">
<h2>Aedes aegypti fecundity<a class="headerlink" href="#aedes-aegypti-fecundity" title="Permalink to this headline">¶</a></h2>
<p>Now let’s look at a disease vector example. These data measure the reponse of * Aedes aegypti * fecundity to temperature.</p>
<p>First load and visualize the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">aedes</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="s">&quot;../data/aedes_fecund.csv&quot;</span><span class="p">)</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">aedes</span><span class="o">$</span><span class="bp">T</span><span class="p">,</span> <span class="n">aedes</span><span class="o">$</span><span class="n">EFD</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;temperature (C)&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;Eggs/day&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_134_0.png" src="../_images/1-ModelFitting-NLLS_134_0.png" />
</div>
</div>
<div class="section" id="the-thermal-performance-curve-models">
<span id="model-fitting-nlls-tpcs"></span><h3>The Thermal Performance Curve models<a class="headerlink" href="#the-thermal-performance-curve-models" title="Permalink to this headline">¶</a></h3>
<p>Let’s define some models for Thermal Performance Curves:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">quad1</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="bp">T</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">Tm</span><span class="p">,</span> <span class="n">c</span><span class="p">){</span>
 <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="bp">T</span><span class="o">-</span><span class="n">T0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">T</span><span class="o">-</span><span class="n">Tm</span><span class="p">)</span> <span class="o">*</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="bp">T</span><span class="o">&lt;</span><span class="n">Tm</span><span class="p">)</span> <span class="o">*</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="bp">T</span><span class="o">&gt;</span><span class="n">T0</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Instead of using the inbuilt quadratic function in R, we we defined our own to make it easier to choose starting values, and so that we can force the function to be equal to zero above and below the minimum and maximum temperature thresholds (more on this below).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">briere</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="bp">T</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">Tm</span><span class="p">,</span> <span class="n">c</span><span class="p">){</span>
 <span class="n">c</span> <span class="o">*</span> <span class="bp">T</span> <span class="o">*</span> <span class="p">(</span><span class="bp">T</span><span class="o">-</span><span class="n">T0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">Tm</span><span class="o">-</span><span class="bp">T</span><span class="p">)</span><span class="o">^</span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">2</span><span class="p">))</span> <span class="o">*</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="bp">T</span><span class="o">&lt;</span><span class="n">Tm</span><span class="p">)</span> <span class="o">*</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="bp">T</span><span class="o">&gt;</span><span class="n">T0</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>The Briere function is a commonly used model for temperature dependence of insect traits. See here <span class="xref myst">section</span> for more info. Unlike the original <span class="xref myst">model definition</span>, we have used <code class="docutils literal notranslate"><span class="pre">abs()</span></code> to allow the NLLS algorithm to explore the full parameter space of <span class="math notranslate nohighlight">\(T_m\)</span>; if we did not do this, the NLLS could fail as soon as a value of <span class="math notranslate nohighlight">\(T_m &lt; T\)</span> was reached during the optimization, because the <a class="reference external" href="https://en.wikipedia.org/wiki/Square_root">square root of a negative number is complex</a>. Another way to deal with this issue is to set parameter bounds on <span class="math notranslate nohighlight">\(T_m\)</span> so that it is can never be less than T. However, this is a more technical approach that we will not go into here.</p>
<p>As in the case of the albatross growth data, we will also compare the above two models with a * straight line * (again, its a linear model, so we can just use <code class="docutils literal notranslate"><span class="pre">lm()</span></code> without needing to define a function for it).</p>
<p>Now fit all 3 models using least squares. Although it’s not as necessary here (as the data don’t have as large values as the albatross example), lets again scale the data first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">scale</span> <span class="o">&lt;-</span> <span class="m">20</span>

<span class="n">aed.lin</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">EFD</span><span class="o">/</span><span class="n">scale</span> <span class="o">~</span> <span class="bp">T</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">aedes</span><span class="p">)</span>

<span class="n">aed.quad</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">EFD</span><span class="o">/</span><span class="n">scale</span><span class="o">~</span><span class="nf">quad1</span><span class="p">(</span><span class="bp">T</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">Tm</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">T0</span><span class="o">=</span><span class="m">10</span><span class="p">,</span> <span class="n">Tm</span><span class="o">=</span><span class="m">40</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="m">0.01</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">aedes</span><span class="p">)</span>

<span class="n">aed.br</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">EFD</span><span class="o">/</span><span class="n">scale</span><span class="o">~</span><span class="nf">briere</span><span class="p">(</span><span class="bp">T</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">Tm</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">T0</span><span class="o">=</span><span class="m">10</span><span class="p">,</span> <span class="n">Tm</span><span class="o">=</span><span class="m">40</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="m">0.1</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">aedes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="exercises-a-id-aedes-exercises-a">
<h3>Exercises <a id='Aedes_Exercises'></a><a class="headerlink" href="#exercises-a-id-aedes-exercises-a" title="Permalink to this headline">¶</a></h3>
<p>(a) Complete the * Aedes * data analysis by fitting the models, calculating predictions and then comparing models. Write a single, self-standing script for it. Which model fits best? By what measure?</p>
<p>(b) In this script, use ggplot instead of base plotting.</p>
</div>
</div>
<div class="section" id="abundance-data-as-an-example">
<h2>Abundance data as an example<a class="headerlink" href="#abundance-data-as-an-example" title="Permalink to this headline">¶</a></h2>
<p>Fluctuations in the abundance (density) of single populations may play a crucial role in ecosystem dynamics and emergent functional characteristics, such as rates of carbon fixation or disease transmission. For example, if vector population densities or their traits change at the same or shorter timescales than the rate of disease transmission, then (vector) abundance fluctuations can cause significant fluctuations in disease transmission rates. Indeed, most disease vectors are small ectotherms with short generation times and greater sensitivity to environmental conditions than their (invariably larger, longer-lived, and often, endothermic) hosts. So understanding how populations vary over time, space, and with respect to environmental variables such as temperature and precipitation is key. We will look at fitting models to the growth of a single population here.</p>
</div>
<div class="section" id="population-growth-rates">
<span id="model-fitting-r-population-growth"></span><h2>Population growth rates<a class="headerlink" href="#population-growth-rates" title="Permalink to this headline">¶</a></h2>
<p>A population grows exponentially while its abundance is low and resources are not limiting (the Malthusian principle). This growth then slows and eventually stops as resources become limiting. There may also be a time lag before the population growth really takes off at the start. We will focus on microbial (specifically, bacterial) growth rates. Bacterial growth in batch culture follows a distinct set of phases; lag phase, exponential phase and stationary phase. During the lag phase a suite of transcriptional machinery is activated, including genes involved in nutrient uptake and metabolic changes, as bacteria prepare for growth. During the exponential growth phase, bacteria divide at a constant rate, the population doubling with each generation. When the carrying capacity of the media is reached, growth slows and the number of cells in the culture stabilizes, beginning the stationary phase.</p>
<p>Traditionally, microbial growth rates were measured by plotting cell numbers or culture density against time on a semi-log graph and fitting a straight line through the exponential growth phase – the slope of the line gives the maximum growth rate (<span class="math notranslate nohighlight">\(r_{max}\)</span>). Models have since been developed which we can use to describe the whole sigmoidal bacterial growth curve (e.g., using NLLS). Here we will take a look at these different approaches, from applying linear models to the exponential phase, through to fitting non-linear models to the full growth curve.</p>
<p>Let’s first generate some “data” on the number of bacterial cells as a function of time that we can play with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">22</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span>
<span class="n">N</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">32500</span><span class="p">,</span> <span class="m">33000</span><span class="p">,</span> <span class="m">38000</span><span class="p">,</span> <span class="m">105000</span><span class="p">,</span> <span class="m">445000</span><span class="p">,</span> <span class="m">1430000</span><span class="p">,</span> <span class="m">3020000</span><span class="p">,</span> <span class="m">4720000</span><span class="p">,</span> <span class="m">5670000</span><span class="p">,</span> <span class="m">5870000</span><span class="p">,</span> <span class="m">5930000</span><span class="p">,</span> <span class="m">5940000</span><span class="p">)</span>

<span class="nf">set.seed</span><span class="p">(</span><span class="m">1234</span><span class="p">)</span> <span class="c1"># set seed to ensure you always get the same random sequence </span>

<span class="n">data</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="p">(</span><span class="m">1</span> <span class="o">+</span> <span class="nf">rnorm</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">sd</span> <span class="o">=</span> <span class="m">0.1</span><span class="p">)))</span> <span class="c1"># add some random error</span>

<span class="nf">names</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="s">&quot;N&quot;</span><span class="p">)</span>

<span class="nf">head</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A data.frame: 6 × 2</caption>
<thead>
	<tr><th></th><th scope=col>Time</th><th scope=col>N</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td> 0</td><td>  28577.04</td></tr>
	<tr><th scope=row>2</th><td> 2</td><td>  33915.52</td></tr>
	<tr><th scope=row>3</th><td> 4</td><td>  42120.88</td></tr>
	<tr><th scope=row>4</th><td> 6</td><td>  80370.17</td></tr>
	<tr><th scope=row>5</th><td> 8</td><td> 464096.05</td></tr>
	<tr><th scope=row>6</th><td>10</td><td>1502365.99</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>Note how we added some random “sampling” error using <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">*</span> <span class="pre">(1</span> <span class="pre">+</span> <span class="pre">rnorm(length(t),</span> <span class="pre">sd</span> <span class="pre">=</span> <span class="pre">.1))</span></code>.</p>
<p>This means that we are adding an error at each time point <span class="math notranslate nohighlight">\(t\)</span> (let’s call this fluctuation <span class="math notranslate nohighlight">\(\epsilon_t\)</span>) as a * percentage * of the population (<span class="math notranslate nohighlight">\(N_t\)</span>) at that time point in a vectorized way. That is, we are performing the operation <span class="math notranslate nohighlight">\(N_t \times (1 + \epsilon_t)\)</span> at all time points at one go. This is important to note because this is often the way that errors appear – proportional to the value being measured.</p>
<p>Now let’s plot these data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="p">))</span> <span class="o">+</span> 
 <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&quot;Time (Hours)&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&quot;Population size (cells)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_146_0.png" src="../_images/1-ModelFitting-NLLS_146_0.png" />
</div>
</div>
<div class="section" id="basic-approach">
<h3>Basic approach<a class="headerlink" href="#basic-approach" title="Permalink to this headline">¶</a></h3>
<p>The size of an exponentially growing population (<span class="math notranslate nohighlight">\(N\)</span>) at any given time (<span class="math notranslate nohighlight">\(t\)</span>) is given by:</p>
<p><span class="math notranslate nohighlight">\(
N(t) = N_0 e^{rt} ,
\)</span></p>
<p>where <span class="math notranslate nohighlight">\(N_0\)</span> is the initial population size and <span class="math notranslate nohighlight">\(r\)</span> is the growth rate. We can re-arrange this to give:</p>
<p><span class="math notranslate nohighlight">\(
r = \frac{\log(N(t)) - \log(N_0)}{t} ,
\)</span></p>
<p>That is, in exponential growth at a constant rate, the growth rate can be simply calculated as the difference in the log of two population sizes, over time. We will log-transform the data and estimate by eye where growth looks exponential.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span> <span class="o">&lt;-</span> <span class="nf">log</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">N</span><span class="p">)</span>

<span class="c1"># visualise</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">LogN</span><span class="p">))</span> <span class="o">+</span> 
 <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&quot;Time (Hours)&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&quot;log(cell number)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_148_0.png" src="../_images/1-ModelFitting-NLLS_148_0.png" />
</div>
</div>
<p>By eye the logged data looks fairly linear (beyond the initial “lag phase” of growth; see below) between hours 5 and 10, so we’ll use that time-period to calculate the growth rate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">$</span><span class="n">Time</span> <span class="o">==</span> <span class="m">10</span><span class="p">,]</span><span class="o">$</span><span class="n">LogN</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">$</span><span class="n">Time</span> <span class="o">==</span> <span class="m">6</span><span class="p">,]</span><span class="o">$</span><span class="n">LogN</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="m">10-6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.732038333517017</div></div>
</div>
<p>This is our first, most basic estimate of <span class="math notranslate nohighlight">\(r\)</span>.</p>
<p>Or, we can decide not to eyeball the data, but just pick the maximum observed gradient of the curve. For this, we can use the the <code class="docutils literal notranslate"><span class="pre">diff()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>0.171269154259665</li><li>0.216670872460636</li><li>0.646099642770272</li><li>1.75344839347772</li><li>1.17470494059035</li><li>0.639023867964838</li><li>0.44952974020198</li><li>0.181493481601755</li><li>-0.000450183952025895</li><li>0.0544907101941003</li><li>-0.0546009242768832</li></ol>
</div></div>
</div>
<p>This gives all the (log) population size differences between successive timepoint pairs. The max of this is what we want, divided by the time-step.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">max</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">))</span><span class="o">/</span><span class="m">2</span> <span class="c1"># 2 is the difference in any successive pair of timepoints</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.87672419673886</div></div>
</div>
</div>
<div class="section" id="using-ols">
<h3>Using OLS<a class="headerlink" href="#using-ols" title="Permalink to this headline">¶</a></h3>
<p>But we can do better than this. To account for some error in measurement, we shouldn’t really take the data points directly, but fit a linear model through them instead, where the slope gives our growth rate. This is pretty much the “traditional” way of calculating microbial growth rates – draw a straight line through the linear part of the log-transformed data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lm_growth</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">LogN</span> <span class="o">~</span> <span class="n">Time</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">$</span><span class="n">Time</span> <span class="o">&gt;</span> <span class="m">2</span> <span class="o">&amp;</span> <span class="n">data</span><span class="o">$</span><span class="n">Time</span> <span class="o">&lt;</span> <span class="m">12</span><span class="p">,])</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">lm_growth</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Call:
lm(formula = LogN ~ Time, data = data[data$Time &gt; 2 &amp; data$Time &lt; 
    12, ])

Residuals:
       3        4        5        6 
 0.21646 -0.38507  0.12076  0.04785 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept)   7.9366     0.5350  14.835  0.00451 **
Time          0.6238     0.0728   8.569  0.01335 * 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.3256 on 2 degrees of freedom
Multiple R-squared:  0.9735,	Adjusted R-squared:  0.9602 
F-statistic: 73.42 on 1 and 2 DF,  p-value: 0.01335
</pre></div>
</div>
</div>
</div>
<p>Npw we get <span class="math notranslate nohighlight">\(r \approx 0.62\)</span>, which is probably closer to the “truth”.</p>
<p>But this is still not ideal because we only guessed the exponential phase by eye. We could do it better by iterating through different windows of points, comparing the slopes and finding which the highest is to give the maximum growth rate, <span class="math notranslate nohighlight">\(r_{max}\)</span>. This is called a “rolling regression”.</p>
<p>Or better still, we can fit a more appropriate mathematical model using NLLS!</p>
</div>
<div class="section" id="using-nlls">
<h3>Using NLLS<a class="headerlink" href="#using-nlls" title="Permalink to this headline">¶</a></h3>
<p>For starters, a classical, (somewhat) mechanistic model is the logistic equation:</p>
<div class="math notranslate nohighlight" id="equation-eq-logist-growth-sol">
<span class="eqno">()<a class="headerlink" href="#equation-eq-logist-growth-sol" title="Permalink to this equation">¶</a></span>\[
N_t = \frac{N_0 K e^{r t}}{K + N_0 (e^{r t} - 1)}
\]</div>
<p>Here <span class="math notranslate nohighlight">\(N_t\)</span> is population size at time <span class="math notranslate nohighlight">\(t\)</span>, <span class="math notranslate nohighlight">\(N_0\)</span> is initial population size, <span class="math notranslate nohighlight">\(r\)</span> is maximum growth rate (AKA <span class="math notranslate nohighlight">\(r_\text{max}\)</span>), and <span class="math notranslate nohighlight">\(K\)</span> is carrying capacity (maximum possible abundance of the population). Note that this model is actually the solution to the differential equation that defines the classic logistic population growth model (eqn. <code class="xref eq docutils literal notranslate"><span class="pre">eq:logist_growth</span></code>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The derivation of eqn. <a class="reference internal" href="#equation-eq-logist-growth-sol">()</a> is covered <span class="xref myst">here</span>. But you don’t need to know the derivation to fit eqn. <a class="reference internal" href="#equation-eq-logist-growth-sol">()</a> to data.</p>
</div>
<p>Let’s fit it to the data. First, we need to define it as a function object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">logistic_model</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">r_max</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">N_0</span><span class="p">){</span> <span class="c1"># The classic logistic equation</span>
 <span class="nf">return</span><span class="p">(</span><span class="n">N_0</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="nf">exp</span><span class="p">(</span><span class="n">r_max</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">K</span> <span class="o">+</span> <span class="n">N_0</span> <span class="o">*</span> <span class="p">(</span><span class="nf">exp</span><span class="p">(</span><span class="n">r_max</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="m">1</span><span class="p">)))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Now fit it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># first we need some starting parameters for the model</span>
<span class="n">N_0_start</span> <span class="o">&lt;-</span> <span class="nf">min</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">N</span><span class="p">)</span> <span class="c1"># lowest population size</span>
<span class="n">K_start</span> <span class="o">&lt;-</span> <span class="nf">max</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">N</span><span class="p">)</span> <span class="c1"># highest population size</span>
<span class="n">r_max_start</span> <span class="o">&lt;-</span> <span class="m">0.62</span> <span class="c1"># use our estimate from the OLS fitting from above</span>

<span class="n">fit_logistic</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">N</span> <span class="o">~</span> <span class="nf">logistic_model</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">r_max</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">N_0</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span>
      <span class="nf">list</span><span class="p">(</span><span class="n">r_max</span><span class="o">=</span><span class="n">r_max_start</span><span class="p">,</span> <span class="n">N_0</span> <span class="o">=</span> <span class="n">N_0_start</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">K_start</span><span class="p">))</span>

<span class="nf">summary</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Formula: N ~ logistic_model(t = Time, r_max, K, N_0)

Parameters:
       Estimate Std. Error t value Pr(&gt;|t|)    
r_max 6.309e-01  3.791e-02  16.641 4.56e-08 ***
N_0   3.317e+03  1.451e+03   2.286   0.0481 *  
K     5.538e+06  7.192e+04  76.995 5.32e-14 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 119200 on 9 degrees of freedom

Number of iterations to convergence: 12 
Achieved convergence tolerance: 1.49e-08
</pre></div>
</div>
</div>
</div>
<p>We did not pay much attention to what starting values we used in the simpler example of fitting the allometric model because the power-law model is easy to fit using NLLS, and starting far from the optimal parameters does not matter too much. Here, we used the actual data to generate more realistic start values for each of the three parameters (<code class="docutils literal notranslate"><span class="pre">r_max</span></code>, <code class="docutils literal notranslate"><span class="pre">N_0</span></code>, <code class="docutils literal notranslate"><span class="pre">K</span></code>) of the Logistic equation.</p>
<p>Now, plot the fit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">timepoints</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">22</span><span class="p">,</span> <span class="m">0.1</span><span class="p">)</span>

<span class="n">logistic_points</span> <span class="o">&lt;-</span> <span class="nf">logistic_model</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">timepoints</span><span class="p">,</span> 
         <span class="n">r_max</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)[</span><span class="s">&quot;r_max&quot;</span><span class="p">],</span> 
         <span class="n">K</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)[</span><span class="s">&quot;K&quot;</span><span class="p">],</span> 
         <span class="n">N_0</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)[</span><span class="s">&quot;N_0&quot;</span><span class="p">])</span>
<span class="n">df1</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span> <span class="n">logistic_points</span><span class="p">)</span>
<span class="n">df1</span><span class="o">$</span><span class="n">model</span> <span class="o">&lt;-</span> <span class="s">&quot;Logistic equation&quot;</span>
<span class="nf">names</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">)</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="p">))</span> <span class="o">+</span>
 <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">geom_line</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">df1</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">model</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">theme</span><span class="p">(</span><span class="n">aspect.ratio</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="o">+</span> <span class="c1"># make the plot square </span>
 <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&quot;Cell number&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_164_0.png" src="../_images/1-ModelFitting-NLLS_164_0.png" />
</div>
</div>
<p>That looks nice, and the <span class="math notranslate nohighlight">\(r_{max}\)</span> estimate we get (0.64) is fairly close to what we got above with OLS fitting.</p>
<p>Note that we’ve done this fitting to the original non transformed data, whilst the linear regressions earlier were on log transformed data. What would this function look like on a log-transformed axis?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">LogN</span><span class="p">))</span> <span class="o">+</span>
 <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">geom_line</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">df1</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">log</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">col</span> <span class="o">=</span> <span class="n">model</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">theme</span><span class="p">(</span><span class="n">aspect.ratio</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="o">+</span> 
 <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&quot;log(Cell number)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_166_0.png" src="../_images/1-ModelFitting-NLLS_166_0.png" />
</div>
</div>
<p>The model actually diverges from the data at the lower end! This was not visible in the previous plot where you examined the model in linear scale (without taking a log) because the deviation of the model is small, and only becomes clear in the log scale. This is because of the way logarithms work. Let’s have a look at this in our Cell counts “data”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">LogN</span><span class="p">))</span> <span class="o">+</span>
 <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">theme</span><span class="p">(</span><span class="n">aspect.ratio</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span><span class="o">+</span> 
 <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&quot;log(N)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_168_0.png" src="../_images/1-ModelFitting-NLLS_168_0.png" />
</div>
</div>
<p>As you can see the logarithm is a strongly nonlinear transformation of any sequence of real numbers, with small numbers close to zero yielding disproportionately large deviations.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may play with increasing the error (by increasing the value of <code class="docutils literal notranslate"><span class="pre">sd</span></code> in synthetic data generation step above) and re-evaluating all the subsequent model fitting steps above. However, note that above some values of <code class="docutils literal notranslate"><span class="pre">sd</span></code>, you will start to get negative values of populations, especially at early time points, which will raise issues with taking a logarithm.</p>
</div>
<p>The above seen deviation of the Logistic model from the data is because this model assumes that the population is growing right from the start (Time = 0), while in “reality” (in our synthetic “data”), this is not what’s happening; the population takes a while to grow truly exponentially (i.e., there is a time lag in the population growth). This time lag is seen frequently in the lab, and is also expected in nature, because when bacteria encounter fresh growth media (in the lab) or a new resource/environment (in the field), they take some time to acclimate, activating genes involved in nutrient uptake and metabolic processes, before beginning exponential growth. This is called the lag phase and can be seen in our example data where exponential growth doesn’t properly begin until around the 4th hour.</p>
<p>To capture the lag phase, more complicated bacterial growth models have been designed.</p>
<p>One of these is the modified Gompertz model (Zwietering et. al., 1990), which has been used frequently in the literature to model bacterial growth:</p>
<div class="math notranslate nohighlight" id="equation-eq-gompertz">
<span class="eqno">()<a class="headerlink" href="#equation-eq-gompertz" title="Permalink to this equation">¶</a></span>\[ 
  \log(N_t) = N_0 + (N_{max} - N_0) e^{-e^{r_{max} \exp(1) \frac{t_{lag} - t}{(N_{max} - N_0) \log(10)} + 1}}
\]</div>
<p>Here maximum growth rate (<span class="math notranslate nohighlight">\(r_{max}\)</span>) is the tangent to the inflection point, <span class="math notranslate nohighlight">\(t_{lag}\)</span> is the x-axis intercept to this tangent (duration of the delay before the population starts growing exponentially) and <span class="math notranslate nohighlight">\(\log\left(\frac{N_{max}}{N_0}\right)\)</span> is the asymptote of the log-transformed population growth trajectory, i.e., the log ratio of maximum population density <span class="math notranslate nohighlight">\(N_{max}\)</span> (aka “carrying capacity”) and initial cell (Population) <span class="math notranslate nohighlight">\(N_0\)</span> density.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that unlike the Logistic growth model above, the Gompertz model is in the log scale. This is because the model is not derived from a differential equation, but was designed * specifically * to be fitted to log-transformed data.</p>
</div>
<p>Now let’s fit and compare the two alternative nonlinear growth models: Logistic and Gompertz.</p>
<p>First, specify the function object for the Gompertz model (we already defined the function for the Logistic model above):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">gompertz_model</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">r_max</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">N_0</span><span class="p">,</span> <span class="n">t_lag</span><span class="p">){</span> <span class="c1"># Modified gompertz growth model (Zwietering 1990)</span>
 <span class="nf">return</span><span class="p">(</span><span class="n">N_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">K</span> <span class="o">-</span> <span class="n">N_0</span><span class="p">)</span> <span class="o">*</span> <span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="nf">exp</span><span class="p">(</span><span class="n">r_max</span> <span class="o">*</span> <span class="nf">exp</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_lag</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">K</span> <span class="o">-</span> <span class="n">N_0</span><span class="p">)</span> <span class="o">*</span> <span class="nf">log</span><span class="p">(</span><span class="m">10</span><span class="p">))</span> <span class="o">+</span> <span class="m">1</span><span class="p">)))</span>
<span class="p">}</span>   
</pre></div>
</div>
</div>
</div>
<p>Again, note that unlike the Logistic growth function above, this function has been written in the log scale.</p>
<p>Now let’s generate some starting values for the NLLS fitting of the Gompertz model.</p>
<p>As we did above for the logistic equation, let’s derive the starting values by using the actual data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">N_0_start</span> <span class="o">&lt;-</span> <span class="nf">min</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)</span> <span class="c1"># lowest population size, note log scale</span>
<span class="n">K_start</span> <span class="o">&lt;-</span> <span class="nf">max</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)</span> <span class="c1"># highest population size, note log scale</span>
<span class="n">r_max_start</span> <span class="o">&lt;-</span> <span class="m">0.62</span> <span class="c1"># use our previous estimate from the OLS fitting from above</span>
<span class="n">t_lag_start</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="o">$</span><span class="n">Time</span><span class="p">[</span><span class="nf">which.max</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)))]</span> <span class="c1"># find last timepoint of lag phase</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>So how did we find a reasonable time lag from the data? *</p></li>
</ul>
<p>Let’s break the last command down:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)</span> <span class="c1"># same as what we did above - get differentials</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>0.171269154259665</li><li>0.216670872460636</li><li>0.646099642770272</li><li>1.75344839347772</li><li>1.17470494059035</li><li>0.639023867964838</li><li>0.44952974020198</li><li>0.181493481601755</li><li>-0.000450183952025895</li><li>0.0544907101941003</li><li>-0.0546009242768832</li></ol>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">diff</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">))</span> <span class="c1"># get the differentials of the differentials (approx 2nd order derivatives)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>0.0454017182009707</li><li>0.429428770309636</li><li>1.10734875070745</li><li>-0.578743452887371</li><li>-0.535681072625511</li><li>-0.189494127762858</li><li>-0.268036258600224</li><li>-0.181943665553781</li><li>0.0549408941461262</li><li>-0.109091634470984</li></ol>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">which.max</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)))</span> <span class="c1"># find the timepoint where this 2nd order derivative really takes off </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">3</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">$</span><span class="n">Time</span><span class="p">[</span><span class="nf">which.max</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)))]</span> <span class="c1"># This then is a good guess for the last timepoint of the lag phase</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">4</div></div>
</div>
<p>Now fit the model using these start values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">fit_gompertz</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">LogN</span> <span class="o">~</span> <span class="nf">gompertz_model</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">r_max</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">N_0</span><span class="p">,</span> <span class="n">t_lag</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span>
      <span class="nf">list</span><span class="p">(</span><span class="n">t_lag</span><span class="o">=</span><span class="n">t_lag_start</span><span class="p">,</span> <span class="n">r_max</span><span class="o">=</span><span class="n">r_max_start</span><span class="p">,</span> <span class="n">N_0</span> <span class="o">=</span> <span class="n">N_0_start</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">K_start</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>You might one or more warning(s) that the model fitting iterations generated NaNs during the fitting procedure for these data (because at some point the NLLS fitting algorithm “wandered” to a combination of K and N_0 values that yields a NaN for log(K/N_0)).</p>
<p>You can ignore these warning in this case. But not always – sometimes these NaNs mean that the equation is wrongly written, or that it generates NaNs across the whole range of the x-values, in which case the model is inappropriate for these data.</p>
<p>Get the model summary:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">summary</span><span class="p">(</span><span class="n">fit_gompertz</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Formula: LogN ~ gompertz_model(t = Time, r_max, K, N_0, t_lag)

Parameters:
      Estimate Std. Error t value Pr(&gt;|t|)    
t_lag  4.80680    0.18433   26.08 5.02e-09 ***
r_max  1.86616    0.08749   21.33 2.45e-08 ***
N_0   10.39142    0.05998  173.24 1.38e-15 ***
K     15.54956    0.05056  307.57  &lt; 2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.09418 on 8 degrees of freedom

Number of iterations to convergence: 10 
Achieved convergence tolerance: 1.49e-08
</pre></div>
</div>
</div>
</div>
<p>And see how the fits of the two nonlinear models compare:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">timepoints</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">24</span><span class="p">,</span> <span class="m">0.1</span><span class="p">)</span>

<span class="n">logistic_points</span> <span class="o">&lt;-</span> <span class="nf">log</span><span class="p">(</span><span class="nf">logistic_model</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">timepoints</span><span class="p">,</span> 
          <span class="n">r_max</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)[</span><span class="s">&quot;r_max&quot;</span><span class="p">],</span> 
          <span class="n">K</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)[</span><span class="s">&quot;K&quot;</span><span class="p">],</span> 
          <span class="n">N_0</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)[</span><span class="s">&quot;N_0&quot;</span><span class="p">]))</span>

<span class="n">gompertz_points</span> <span class="o">&lt;-</span> <span class="nf">gompertz_model</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">timepoints</span><span class="p">,</span> 
         <span class="n">r_max</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_gompertz</span><span class="p">)[</span><span class="s">&quot;r_max&quot;</span><span class="p">],</span> 
         <span class="n">K</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_gompertz</span><span class="p">)[</span><span class="s">&quot;K&quot;</span><span class="p">],</span> 
         <span class="n">N_0</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_gompertz</span><span class="p">)[</span><span class="s">&quot;N_0&quot;</span><span class="p">],</span> 
         <span class="n">t_lag</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_gompertz</span><span class="p">)[</span><span class="s">&quot;t_lag&quot;</span><span class="p">])</span>

<span class="n">df1</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span> <span class="n">logistic_points</span><span class="p">)</span>
<span class="n">df1</span><span class="o">$</span><span class="n">model</span> <span class="o">&lt;-</span> <span class="s">&quot;Logistic model&quot;</span>
<span class="nf">names</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="s">&quot;LogN&quot;</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">)</span>

<span class="n">df2</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span> <span class="n">gompertz_points</span><span class="p">)</span>
<span class="n">df2</span><span class="o">$</span><span class="n">model</span> <span class="o">&lt;-</span> <span class="s">&quot;Gompertz model&quot;</span>
<span class="nf">names</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="s">&quot;LogN&quot;</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">)</span>

<span class="n">model_frame</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">)</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">LogN</span><span class="p">))</span> <span class="o">+</span>
 <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">geom_line</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">model_frame</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">LogN</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">model</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span> <span class="c1"># make the background white</span>
 <span class="nf">theme</span><span class="p">(</span><span class="n">aspect.ratio</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="o">+</span> <span class="c1"># make the plot square </span>
 <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&quot;log(Abundance)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1-ModelFitting-NLLS_187_0.png" src="../_images/1-ModelFitting-NLLS_187_0.png" />
</div>
</div>
<p>Clearly, the Gompertz model fits way better than the logistic growth equation in this case! Note also that there is a big difference in the fitted value of <span class="math notranslate nohighlight">\(r_{max}\)</span> from the two models; the value is much lower from the Logistic model because it ignores the lag phase, including it into the exponential growth phase.</p>
<p>You can now perform model selection like you did above in the allometric scaling example.</p>
</div>
<div class="section" id="exercises">
<h3>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h3>
<p>(a) Calculate the confidence intervals on the parameters of each of the two fitted models, and use model selection (using AIC and/or BIC) as you did before to see if you can determine the best-fitting model among the three.</p>
<p>(b) Alternatively, for a different random sequence of fluctuations, one or more of the models may fail to fit (a <code class="docutils literal notranslate"><span class="pre">singular</span> <span class="pre">gradiant</span> <span class="pre">matrix</span></code> error). Try repeating the above fitting with a different random seed (change the integers given to the <code class="docutils literal notranslate"><span class="pre">random.seed(</span> <span class="pre">)</span></code> function), or increase the sampling error by increasing the standard deviation and see if it happens. If/when the NLLS optimization does fail to converge (the RSS minimum was not found), you can try to fix it by changing the starting values.</p>
<p>(c) Repeat the model comparison exercise 1000 times (You will have to write a loop), and determine if/whether one model generally wins more often than the others. Note that each run will generate a slightly different dataset, because we are adding a vector of random errors every time the “data” are generated. This may result in failure of the NLLS fitting to converge, in which case you will need to use the <a class="reference external" href="https://nbviewer.jupyter.org/github/mhasoba/TheMulQuaBio/blob/master/notebooks/07-R.ipynb"><code class="docutils literal notranslate"><span class="pre">try()</span></code> or <code class="docutils literal notranslate"><span class="pre">tryCatch</span></code> functions</a>.</p>
<p>(d) Repeat (b), but increase the error by increasing the standard deviation of the normal error distribution, and see if there are differences in the robustness of the models to sampling/experimental errors. You may also want to try changing the distribution of the errors to some non-normal distribution and see what happens.</p>
</div>
</div>
<div class="section" id="some-tips-and-tricks-for-nlls-fitting">
<h2>Some tips and tricks for NLLS fitting<a class="headerlink" href="#some-tips-and-tricks-for-nlls-fitting" title="Permalink to this headline">¶</a></h2>
<div class="section" id="starting-values">
<span id="model-fitting-nlls-starting-values"></span><h3>Starting values<a class="headerlink" href="#starting-values" title="Permalink to this headline">¶</a></h3>
<p>The main challenge for NLLS fitting is finding starting (initial) values for the parameters, which the algorithm needs to proceed with the fitting/optimization. Inappropriate starting values can result in the algorithm finding parameter combinations represent convergence to a local optimum rather than the (globally) optimal solution. Starting parameter estimates can also result in or complete “divergence”, i.e., the search results in a combination of parameters that cause mathematical “singularity” (e.g., log(0) or division by zero).</p>
<div class="section" id="obtaining-them">
<h4>Obtaining them<a class="headerlink" href="#obtaining-them" title="Permalink to this headline">¶</a></h4>
<p>Finding the starting values is a <a class="reference external" href="https://en.wikipedia.org/wiki/Non-linear_least_squares#Initial_parameter_estimates">bit of an art</a>. There is no method for finding starting values that works universally (across different types of models).</p>
<p>The one universal rule though, is that finding starting values requires you to understand the meaning of each of the parameters in your model. So, for example, in the population <a class="reference internal" href="#model-fitting-r-population-growth"><span class="std std-ref">growth rate example</span></a>, the parameters in both the nonlinear models that <a class="reference internal" href="#model-fitting-r-population-growth"><span class="std std-ref">we covered</span></a> (Logistic growth, eqn. <a class="reference internal" href="#equation-eq-logist-growth-sol">()</a> , Gompertz model; eqn. <a class="reference internal" href="#equation-eq-gompertz">()</a>) have a clear meaning.</p>
<p>Furthermore, you will typically need to determine starting values <em>specific</em> to each model <em>and</em> each dataset that that you are wanting to fit that model to (e.g., every distinct functional response dataset to be <span class="xref myst">fitted to the Holling Type II model</span>). To do so, understanding how each parameter in the model corresponds to features of the actual data is really necessary.</p>
<p>For example, in the Gompertz population growth rate model (eqn. <a class="reference internal" href="#equation-eq-gompertz">()</a>), your starting values generator function would, for each dataset,</p>
<ul class="simple">
<li><p>Calculate a starting value for <span class="math notranslate nohighlight">\(r_{max}\)</span> by searching for the steepest slope of the growth curve (e.g., with a rolling OLS regression)</p></li>
<li><p>Calculate a starting value of <span class="math notranslate nohighlight">\(t_{lag}\)</span> by intersecting the fitted line with the x (time)-axis</p></li>
<li><p>Calculate a starting value for the asymptote <span class="math notranslate nohighlight">\(K\)</span> as the highest data (abundance) value in the dataset.</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Ideally, you should write a separate a function that calculates starting values for the model parameters.</p>
</div>
</div>
<div class="section" id="sampling-them">
<h4>Sampling them<a class="headerlink" href="#sampling-them" title="Permalink to this headline">¶</a></h4>
<p>Once you have worked out how to generate starting values for each non-linear model and dataset, a good next step for optimizing the fitting across multiple datasets (and thus maximize how many datasets are successfully fitted to the model) is to <em>rerun fitting attempts multiple times, sampling each of the starting values (simultaneously) randomly</em> (that is, randomly vary the set of starting values a bit each time). This sampling of starting values will increase the likelihood of the NLLS optimization algorithm finding a solution (optimal combination of parameters), and not getting stuck in a combination of parameters somewhere far away from that optimal solution.</p>
<p>In particular,</p>
<ul class="simple">
<li><p>You can choose a Gaussian/Normal distribution if you have high confidence in mean value of parameter, or</p></li>
<li><p>You can uniform distribution if you have low confidence in the mean, but higher confidence in the range of values that the parameter can take.
In both cases, the <em>mean</em> of the sampling distribution will be the starting value you inferred from the model and the data (previous section).</p></li>
</ul>
<p>Furthermore,</p>
<ul class="simple">
<li><p>Whichever distribution you choose (gaussian vs uniform), you will need to determine what range of values to restrict each parameter’s samples to. In the case of the normal distribution, this is determined by what standard deviation parameter (you choose), and in the case of the uniform distribution, this is determined by what lower and upper bound (you choose). Generally, a good approach is to set the bound to be some <em>percent</em> (say 5-10%) of the parameter’s (mean) starting value. In both cases the chosen range to restrict the sampling to would typically be some subset of the model’s <em>parameter bounds</em> (next section).</p></li>
<li><p><em>How many times to re-run</em> the fitting for a single dataset and model?* – this depends on how “difficult” the model is, and how much computational power you have.</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>For the sampling of starting values, recall that you learned to generate random numbers from probability distributions in both the <span class="xref myst">R</span> and <span class="xref myst">Python</span> chapters).</p>
</div>
<p>You may also try and use a more sophisticated approach such as <a class="reference external" href="https://en.wikipedia.org/wiki/Hyperparameter_optimization#Approaches">grid searching</a> for varying your starting values randomly. An example is in the <a class="reference internal" href="2-ModelFitting-MLE.html#modelfitting-mle-likelihoodsurface"><span class="std std-ref">MLE chapter</span></a>.</p>
</div>
</div>
<div class="section" id="bounding-parameters-revisited">
<h3>Bounding parameters revisited<a class="headerlink" href="#bounding-parameters-revisited" title="Permalink to this headline">¶</a></h3>
<p>At the start, we looked at an <a class="reference external" href="20-ModelFitting-NLLS:Bounding">example</a> of NLLS fitting where we bounded the parameters. It can be a good idea to restrict the range of values that the each of the model’s parameters can take <em>during any one fitting/optimization run</em>. To “bound” a parameter in this way means to give it upper and lower limits. By doing so, during one optimization/fitting (e.g., one call to <code class="docutils literal notranslate"><span class="pre">nlsLM</span></code>, to fit one model, to one dataset), the fitting algorithm does not allow a parameter to go outside some limits. This reduces the chances of the optimization getting stuck too far from the solution, or failing completely due to some mathematical singularity (e.g., log(0)).</p>
<p>The bounds are typically fixed for each parameter of a model <em>at the level of the model</em> (e.g., they do not change based on each dataset). For example, in the Gompertz model for growth rates (eqn. <a class="reference internal" href="#equation-eq-gompertz">()</a>), you can limit the growth rate parameter to never be negative (the bounds would be <span class="math notranslate nohighlight">\([0,\infty]\)</span>), or restrict it further to be some value between zero and an upper limit (say, 10) that you know organismal growth rates cannot exceed (the bounds would in this case would be <span class="math notranslate nohighlight">\([0,10]\)</span>).</p>
<p>However, as we saw in the Michaelis-Menten model fitting <a class="reference external" href="20-ModelFitting-NLLS:Bounding">example</a>, bounding the parameters too much (excessively narrow ranges) can result in poor solutions because the algorithm cannot explore sufficient parameter space.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The values of the parameter bounds you choose, of course, may depend on the <em>units of measurement</em> of the data. For example, in <a class="reference external" href="https://en.wikipedia.org/wiki/International_System_of_Units">SI</a>, growth rates in the Logistic or Gompertz models would be in units of s<span class="math notranslate nohighlight">\(^{-1}\)</span>).</p>
</div>
<p>Irrespective of which computer language the NLLS fitting algorithm is implemented in (<code class="docutils literal notranslate"><span class="pre">nlsLM</span></code>  in R or <code class="docutils literal notranslate"><span class="pre">lmfit</span></code> in Python), the fitting command/method will have options for setting the parameter bounds. In particular,</p>
<ul class="simple">
<li><p>For <code class="docutils literal notranslate"><span class="pre">nlsLM</span></code> in R, look up https://www.rdocumentation.org/packages/minpack.lm/versions/1.2-1/topics/nlsLM (the <code class="docutils literal notranslate"><span class="pre">lower</span></code> and <code class="docutils literal notranslate"><span class="pre">upper</span></code> arguments to the function).</p></li>
<li><p>For <code class="docutils literal notranslate"><span class="pre">lmfit</span></code> in Python, look up https://lmfit.github.io/lmfit-py/parameters.html (and in particular, https://lmfit.github.io/lmfit-py/parameters.html#lmfit.parameter.Parameter) (the <code class="docutils literal notranslate"><span class="pre">min</span></code> and <code class="docutils literal notranslate"><span class="pre">max</span></code> arguments).</p></li>
</ul>
<p><em>Bounding the parameter values has nothing to do, per se, with sampling the starting values of each parameter, though if you choose to sample starting values (explained in previous section), you need to make sure that the samples don’t exceed the pre-set bounds (explained in this section).</em></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Python’s <code class="docutils literal notranslate"><span class="pre">lmfit</span></code> has an option to also internally vary the parameter. So by using a sampling approach as described in the previous section, <em>and</em> allowing the parameter to vary (note that <code class="docutils literal notranslate"><span class="pre">vary=True</span></code> is the default) within <code class="docutils literal notranslate"><span class="pre">lmfit</span></code>, you will be in essence be imposing sampling twice. This may or may not improve fitting performance – try it out both ways.</p>
</div>
</div>
</div>
<div class="section" id="readings-and-resources">
<h2>Readings and Resources<a class="headerlink" href="#readings-and-resources" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Motulsky, Harvey, and Arthur Christopoulos. Fitting models to biological data using linear and nonlinear regression: a practical guide to curve fitting. OUP USA, 2004: <a class="reference external" href="https://www.facm.ucl.ac.be/cooperation/Vietnam/WBI-Vietnam-October-2011/Modelling/RegressionBook.pdf">https://www.facm.ucl.ac.be/cooperation/Vietnam/WBI-Vietnam-October-2011/Modelling/RegressionBook.pdf</a></p></li>
<li><p>These are a pretty good series of notes on NLLS (even if you are using R instead of Python): <a class="reference external" href="https://lmfit.github.io/lmfit-py/intro.html">https://lmfit.github.io/lmfit-py/intro.html</a></p></li>
<li><p>Another technical description of NLLS  algorithms: <a class="reference external" href="https://www.gnu.org/software/gsl/doc/html/nls.html">https://www.gnu.org/software/gsl/doc/html/nls.html</a></p></li>
<li><p>Johnson, J. B. &amp; Omland, K. S. 2004 Model selection in ecology and evolution. Trends Ecol. Evol. 19, 101–108.</p></li>
<li><p>The <em>nlstools</em> package for NLLS fit diagnostics: <a class="reference external" href="https://rdrr.io/rforge/nlstools">https://rdrr.io/rforge/nlstools</a></p>
<ul>
<li><p>The original paper: <a class="reference external" href="http://dx.doi.org/10.18637/jss.v066.i05">http://dx.doi.org/10.18637/jss.v066.i05</a></p></li>
</ul>
</li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            kernelName: "ir",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Samraat Pawar<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>